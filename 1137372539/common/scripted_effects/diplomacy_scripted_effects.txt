#
# Examples of setting variables affecting stuff with pacts (favours)
#
#custom_override_tooltip = { #affects monthly opinion gain
#	tooltip = {
#		localization_key = IMPROVE_RELATION_BONUS
#		RECEIVER = USA
#		VALUE = 0.2
#	}
#	
#	set_variable = { GER.befriend_factor@USA = 0.2 } 
#}
#
#custom_override_tooltip = { #affects total opinion cost for doing a pact
#	tooltip = {
#		localization_key = FAVOUR_COST_BONUS
#		RECEIVER = ITA
#		VALUE = -0.2
#	}
#	
#	set_variable = { GER.favour_cost@ITA = -0.2 } #20% less cost
#}
#
#custom_override_tooltip = { #affects the increasing cost per pact
#	tooltip = {
#		localization_key = FAVOUR_RAMP_COST_BONUS
#		RECEIVER = USA
#		VALUE = -0.2
#	}
#	
#	set_variable = { GER.favour_ramp_cost@USA = -0.2 } 
#}
#
# set_temp_variable = { favour_v = token:diplo_law_bonus }
# ROOT_request_favour_with_THIS = yes
#
# set_temp_variable = { favour_v = token:diplo_law_bonus }
# THIS_request_favour_with_PREV = yes
#
#
#
# set_temp_variable = { favour_v = token:diplo_law_bonus }
# ROOT_set_favour_with_THIS = yes
#
# set_temp_variable = { favour_v = token:diplo_law_bonus }
# THIS_set_favour_with_PREV = yes
#
#
#
# set_temp_variable = { opinion = 50 } #adds this amount of opinion from "Improve Relations" - it will still be capped at the max
# THIS_add_opinion_to_PREV = yes

d_test_favours_as_players = {
	if = {
		limit = {
			has_global_flag = favour_test_player
		}
		clr_global_flag = favour_test_player
		log = "Favours will no longer assume everyone is a player"
	}
	else = {
		set_global_flag = favour_test_player
		log = "Favours will assume everyone is a player"
	}
}
set_original_capital = {
	if = {
		limit = {
			OR = {
				NOT = { has_variable = original_capital }
				check_variable = { original_capital = 0 }
			}
		}
		set_variable = { original_capital = capital }
	}
}

ROOT_bypass_volunteer_ideology_for_THIS = {
	custom_override_tooltip = {
		tooltip = diplomacy_bypass_volunteer_ideology
	
		ROOT = { 
			set_country_flag = bypass_volunteer_ideology@PREV 
		}
	}
}

ROOT_disable_land_volunteers_for_THIS = {
	custom_override_tooltip = {
		tooltip = diplomacy_disable_land_volunteers
		ROOT = {
			add_relation_modifier = {
				target = PREV
				modifier = diplomacy_disable_land_volunteers
			}
		}
	}
}

ROOT_disable_air_volunteers_for_THIS = {
	custom_override_tooltip = {
		tooltip = diplomacy_disable_air_volunteers
		ROOT = {
			add_relation_modifier = {
				target = PREV
				modifier = diplomacy_disable_air_volunteers
			}
		}
	}
}

update_diplomacy_start = {
	if = {
		limit = {
			tag = GER
		}
			
		clear_array = global.diplomatic_favours
		add_to_array = { global.diplomatic_favours = token:diplo_trade_bonus }
		add_to_array = { global.diplomatic_favours = token:diplo_law_bonus }
		add_to_array = { global.diplomatic_favours = token:diplo_command_bonus }
		add_to_array = { global.diplomatic_favours = token:diplo_production_bonus }
		add_to_array = { global.diplomatic_favours = token:diplo_naval_bonus }
		add_to_array = { global.diplomatic_favours = token:diplo_resource_bonus }
		add_to_array = { global.diplomatic_favours = token:diplo_experience_bonus }
		add_to_array = { global.diplomatic_favours = token:diplo_license_bonus }
		if = {
			limit = {
				has_dlc = "La Resistance"
			}
			add_to_array = { global.diplomatic_favours = token:diplo_intelligence_bonus }
		}
		add_to_array = { global.diplomatic_favours = token:diplo_research_bonus }
	}
	if = {
		limit = {
			is_chinese_nations/TAG = yes
			NOT = { is_subject_of = JAP }
			NOT = { tag = SIK }
		}
		set_rule = {
			desc = is_warlord
			can_access_market = no
		}
		if = {
			limit = {
				NOT = { tag = CHI }
			}
			add_relation_rule_override = {
				target = CHI
				usage_desc = is_warlord
				can_access_market = yes
			}
			CHI = {
				meta_effect = {
					text = {
						add_relation_rule_override = {
							target = [X]
							usage_desc = is_warlord
							can_access_market = yes
						}
					}
					X = "[Prev.GetTag]"
				}
			}
		}
	}
			
	if = {
		limit = {
			OR = {
				tag = ENG 
				is_subject_of = ENG
				tag = FRA
				tag = USA
				is_subject_of = FRA
			}
		}
		add_relation_rule_override = {
			target = SOV
			usage_desc = bolshevik_threat
			can_access_market = no
		}		
	}
		
}

update_diplomacy_ideology = {
	#log = "UPDATE OPINION MODIFIERS [This.GetTag] [?global.date]"
	set_country_flag = BI_ideology_opinion_applied@ROOT
	
	update_market_ideology = yes
	
	every_other_country = {
		remove_opinion_modifier = {
			target = PREV
			modifier = same_government
		}
		remove_opinion_modifier = {
			target = PREV
			modifier = similar_government
		}
		remove_opinion_modifier = {
			target = PREV
			modifier = different_government
		}
		PREV = {
			remove_opinion_modifier = {
				target = PREV
				modifier = same_government
			}
			remove_opinion_modifier = {
				target = PREV
				modifier = similar_government
			}
			remove_opinion_modifier = {
				target = PREV
				modifier = different_government
			}
		}
	}

	clear_temp_array = different
	add_to_temp_array = { different = token:conservatism }
	add_to_temp_array = { different = token:liberalism }
	add_to_temp_array = { different = token:socialism }
	add_to_temp_array = { different = token:agrarianism }
	add_to_temp_array = { different = token:fascism }
	add_to_temp_array = { different = token:communism }
	add_to_temp_array = { different = token:neutrality }
	add_to_temp_array = { different = token:monarchism }
	
	## SAME
	for_each_scope_loop = {
		array = global.ideology@var:current_party_ideology_group
		
		add_opinion_modifier = { target = PREV modifier = same_government }
		reverse_add_opinion_modifier = { target = PREV modifier = same_government }
	}
	remove_from_temp_array = { different = current_party_ideology_group }
	
	if = {
		limit = {
			democratic_govt = yes
		}
		
		if = {
			limit = { has_government = conservatism }
				
			## SIMILAR
			for_each_scope_loop = {
				array = global.ideology@liberalism
				
				add_opinion_modifier = { target = PREV modifier = similar_government }
				reverse_add_opinion_modifier = { target = PREV modifier = similar_government }
			}
			remove_from_temp_array = { different = token:liberalism }
			for_each_scope_loop = {
				array = global.ideology@socialism
				
				add_opinion_modifier = { target = PREV modifier = similar_government }
				reverse_add_opinion_modifier = { target = PREV modifier = similar_government }
			}
			remove_from_temp_array = { different = token:socialism }
			for_each_scope_loop = {
				array = global.ideology@agrarianism
				
				add_opinion_modifier = { target = PREV modifier = similar_government }
				reverse_add_opinion_modifier = { target = PREV modifier = similar_government }
			}
			remove_from_temp_array = { different = token:agrarianism }
		}
		else_if = {
			limit = { has_government = liberalism }
				
			## SIMILAR
			for_each_scope_loop = {
				array = global.ideology@conservatism
				
				add_opinion_modifier = { target = PREV modifier = similar_government }
				reverse_add_opinion_modifier = { target = PREV modifier = similar_government }
			}
			remove_from_temp_array = { different = token:conservatism }
			for_each_scope_loop = {
				array = global.ideology@socialism
				
				add_opinion_modifier = { target = PREV modifier = similar_government }
				reverse_add_opinion_modifier = { target = PREV modifier = similar_government }
			}
			remove_from_temp_array = { different = token:socialism }
			for_each_scope_loop = {
				array = global.ideology@agrarianism
				
				add_opinion_modifier = { target = PREV modifier = similar_government }
				reverse_add_opinion_modifier = { target = PREV modifier = similar_government }
			}
			remove_from_temp_array = { different = token:agrarianism }
		}
		else_if = {
			limit = { has_government = socialism }
				
			## SIMILAR
			for_each_scope_loop = {
				array = global.ideology@conservatism
				
				add_opinion_modifier = { target = PREV modifier = similar_government }
				reverse_add_opinion_modifier = { target = PREV modifier = similar_government }
			}
			remove_from_temp_array = { different = token:conservatism }
			for_each_scope_loop = {
				array = global.ideology@liberalism
				
				add_opinion_modifier = { target = PREV modifier = similar_government }
				reverse_add_opinion_modifier = { target = PREV modifier = similar_government }
			}
			remove_from_temp_array = { different = token:liberalism }
			for_each_scope_loop = {
				array = global.ideology@agrarianism
				
				add_opinion_modifier = { target = PREV modifier = similar_government }
				reverse_add_opinion_modifier = { target = PREV modifier = similar_government }
			}
			remove_from_temp_array = { different = token:agrarianism }
		}
		else_if = {
			limit = { has_government = agrarianism }
				
			## SIMILAR
			for_each_scope_loop = {
				array = global.ideology@conservatism
				
				add_opinion_modifier = { target = PREV modifier = similar_government }
				reverse_add_opinion_modifier = { target = PREV modifier = similar_government }
			}
			remove_from_temp_array = { different = token:conservatism }
			for_each_scope_loop = {
				array = global.ideology@liberalism
				
				add_opinion_modifier = { target = PREV modifier = similar_government }
				reverse_add_opinion_modifier = { target = PREV modifier = similar_government }
			}
			remove_from_temp_array = { different = token:liberalism }
			for_each_scope_loop = {
				array = global.ideology@socialism
				
				add_opinion_modifier = { target = PREV modifier = similar_government }
				reverse_add_opinion_modifier = { target = PREV modifier = similar_government }
			}
			remove_from_temp_array = { different = token:socialism }
		}
	}
	else_if = {
		limit = {
			has_government = neutrality
		}
		
		## SIMILAR
		for_each_scope_loop = {
			array = global.ideology@monarchism
			
			add_opinion_modifier = { target = PREV modifier = similar_government }
			reverse_add_opinion_modifier = { target = PREV modifier = similar_government }
		}
		remove_from_temp_array = { different = token:monarchism }
		
	}
	else_if = {
		limit = {
			has_government = monarchism
		}
		
		## SIMILAR
		for_each_scope_loop = {
			array = global.ideology@neutrality
			
			add_opinion_modifier = { target = PREV modifier = similar_government }
			reverse_add_opinion_modifier = { target = PREV modifier = similar_government }
		}
		remove_from_temp_array = { different = token:neutrality }
		
	}
	
	for_each_loop = {
		array = different
		
		for_each_scope_loop = {
			array = global.ideology@var:v
			
			add_opinion_modifier = {
				target = PREV
				modifier = different_government
			}
			reverse_add_opinion_modifier = {
				target = PREV
				modifier = different_government
			}
		}
	}
	clear_variable = old_ideology
}

update_market_ideology = {
	set_temp_variable = { same_ideology_value = 15 }

	if = {
		limit = {
			has_dlc = "Arms Against Tyranny"
			date > 1936.1.2
		}
		
		add_to_temp_array = { same_democracy = token:conservatism }
		add_to_temp_array = { same_democracy = token:liberalism }
		add_to_temp_array = { same_democracy = token:socialism }
		add_to_temp_array = { same_democracy = token:agrarianism }
	
		if = {
			limit = { #was non democratic before and switched now
				OR = {
					check_variable = { old_ideology = token:fascism }
					check_variable = { old_ideology = token:communism }
					check_variable = { old_ideology = token:monarchism }
					check_variable = { old_ideology = token:neutrality }
				}
				OR = {
					has_government = conservatism
					has_government = liberalism
					has_government = socialism
					has_government = agrarianism
				}
			}
			
			# Dont apply the strat towards same ideology
			remove_from_temp_array = { same_democracy = current_party_ideology_group }
				
			# Add strategy to and from democratic countries
		
			for_each_loop = {
				array = same_democracy
					
				for_each_scope_loop = {
					array = global.ideology@var:v
				
					meta_effect = {
						text = {
							add_ai_strategy = {
								type = equipment_market_trade_desire
								id = [X]
								value = [V]
							}
						}
						X = "[Prev.GetTag]"
						V = "[?same_ideology_value]"
					}
					PREV = {
						meta_effect = {
							text = {
								add_ai_strategy = {
									type = equipment_market_trade_desire
									id = [X]
									value = [V]
								}
							}
							X = "[Prev.GetTag]"
							V = "[?same_ideology_value]"
						}
					}
				}
			}
		}
		else_if = {
			limit = { #was democratic before and switched now
				OR = {
					check_variable = { old_ideology = token:conservatism }
					check_variable = { old_ideology = token:liberalism }
					check_variable = { old_ideology = token:socialism }
					check_variable = { old_ideology = token:agrarianism }
				}
				OR = {
					has_government = fascism
					has_government = communism
					has_government = monarchism
					has_government = neutrality
				}
			}
			remove_from_temp_array = { same_democracy = old_ideology }
			
			# Remove strategy to and from democratic countries
		
			for_each_loop = {
				array = same_democracy
					
				for_each_scope_loop = {
					array = global.ideology@var:v
				
					meta_effect = {
						text = {
							add_ai_strategy = {
								type = equipment_market_trade_desire
								id = [X]
								value = -[V]
							}
						}
						X = "[Prev.GetTag]"
						V = "[?same_ideology_value]"
					}
					PREV = {
						meta_effect = {
							text = {
								add_ai_strategy = {
									type = equipment_market_trade_desire
									id = [X]
									value = -[V]
								}
							}
							X = "[Prev.GetTag]"
							V = "[?same_ideology_value]"
						}
					}
				}
			}
		}
		else_if = {
			limit = { #was democratic before and still is democratic
				OR = {
					check_variable = { old_ideology = token:conservatism }
					check_variable = { old_ideology = token:liberalism }
					check_variable = { old_ideology = token:socialism }
					check_variable = { old_ideology = token:agrarianism }
				}
				OR = {
					has_government = conservatism
					has_government = liberalism
					has_government = socialism
					has_government = agrarianism
				}
			}
			# Dont apply the strat towards same ideology
			remove_from_temp_array = { same_democracy = current_party_ideology_group }
				
			for_each_scope_loop = {
				array = global.ideology@var:current_party_ideology_group
			
				meta_effect = {
					text = {
						add_ai_strategy = {
							type = equipment_market_trade_desire
							id = [X]
							value = -[V]
						}
					}
					X = "[Prev.GetTag]"
					V = "[?same_ideology_value]"
				}
				PREV = {
					meta_effect = {
						text = {
							add_ai_strategy = {
								type = equipment_market_trade_desire
								id = [X]
								value = -[V]
							}
						}
						X = "[Prev.GetTag]"
						V = "[?same_ideology_value]"
					}
				}
			}
				
			# Remove strategy for old ideology
	
			for_each_scope_loop = {
				array = global.ideology@var:old_ideology
			
				meta_effect = {
					text = {
						add_ai_strategy = {
							type = equipment_market_trade_desire
							id = [X]
							value = [V]
						}
					}
					X = "[Prev.GetTag]"
					V = "[?same_ideology_value]"
				}
				PREV = {
					meta_effect = {
						text = {
							add_ai_strategy = {
								type = equipment_market_trade_desire
								id = [X]
								value = [V]
							}
						}
						X = "[Prev.GetTag]"
						V = "[?same_ideology_value]"
					}
				}
			}
		}
	}
}

cancel_improve_relations = { # ROOT = improver; THIS = target
	ROOT = {
		if = { #To prevent ai restarting it on the same day, it should cancel it by itself due to negative ai desire
			limit = {
				is_ai = no
			}
			diplomatic_relation = {
				country = PREV
				relation = improve_relation
				active = no
			}
		}
		clear_variable = relation_leftover@THIS
		#clr_country_flag = improved_relation@PREV - delayed removal 1 day later
		set_country_flag = { flag = has_cancel_improve_relation@PREV value = 1 days = 1 }
	
	}
	
	# Replace opinion modifier with the one with decay
	
	hidden_effect = {
		remove_opinion_modifier = {
			target = ROOT
			modifier = improved_relation
		}
		for_loop_effect = {
			end = ROOT.relation@THIS
			
			add_opinion_modifier = {
				target = ROOT
				modifier = improved_relation_decay
			}
		}
		
		country_event = { id = BI_on_action.5 days = 1 }
	}
	
	if = {
		limit = {
			ROOT = { has_country_flag = { flag = improved_relation@PREV value = 1 days < 30 } }
		}
		custom_effect_tooltip = IMPROVE_RELATION_DISABLED_CANCEL
	}
	
	improve_relation_tooltip = yes
}

update_improve_relations = {
	for_each_scope_loop = {
		array = befriend_targets 
		
		if = {
			limit = {
				ROOT = { has_country_flag = improved_relation@PREV }
			}
			
			if = {
				limit = {
					set_temp_variable = { max_befriend = constant:improve_relation.max }
					add_to_temp_variable = { max_befriend = ROOT.modifier@max_opinion_gain }
					NOT = { check_variable = { ROOT.relation@THIS = max_befriend } }
					NOT = { check_variable = { ROOT.relation@THIS > max_befriend } }
				}
					
				set_temp_variable = { factor = 1 }
				add_to_temp_variable = { factor = ROOT.befriend_factor@THIS }
				add_to_temp_variable = { factor = ROOT.modifier@opinion_gain_monthly_factor }
				add_to_temp_variable = { factor = modifier@foreign_opinion_gain_monthly_factor }
				if = {
					limit = {
						is_ally_with = ROOT
					}
					add_to_temp_variable = { factor = ROOT.modifier@opinion_gain_monthly_ally_factor }
				}
				if = {
					limit = {
						has_same_government_as_root = yes
					}
					set_temp_variable = { gain = constant:improve_relation.same_ideology }
			
					add_to_temp_variable = { factor = ROOT.modifier@opinion_gain_monthly_same_ideology_factor }
					multiply_temp_variable = { gain = factor }
					add_to_temp_variable = { gain = ROOT.modifier@opinion_gain_monthly_same_ideology }
				}
				else = {
					set_temp_variable = { gain = constant:improve_relation.different_ideology }
					
					add_to_temp_variable = { factor = ROOT.modifier@opinion_gain_monthly_different_ideology_factor }
					multiply_temp_variable = { gain = factor }
					add_to_temp_variable = { gain = ROOT.modifier@opinion_gain_monthly_different_ideology }
				}
				add_to_temp_variable = { gain = ROOT.modifier@opinion_gain_monthly }
				add_to_temp_variable = { gain = modifier@foreign_opinion_gain_monthly_factor }
				set_temp_variable = { gain_uncapped = gain }
				add_to_temp_variable = { gain = ROOT.relation_leftover@THIS }
				clear_variable = ROOT.relation_leftover@THIS
				
				set_temp_variable = { max_change = max_befriend }
				subtract_from_temp_variable = { max_change = ROOT.relation@THIS }
				if = {
					limit = {
						check_variable = { gain > max_change }
						ROOT = { has_country_flag = cancel_at_max_opinion@PREV }
					}
					add_to_temp_array = { cancel_befriend = THIS }
				}
				clamp_temp_variable = { var = gain max = max_change }
				
				set_temp_variable = { gain_int = 0 }
				while_loop_effect = {
					limit = {
						check_variable = { gain > 0.999 }
					}
					
					subtract_from_temp_variable = { gain = 1 }
					add_to_temp_variable = { gain_int = 1 }
					
					add_opinion_modifier = {
						target = ROOT
						modifier = improved_relation
					}
				}
				
				set_variable = { ROOT.relation_leftover@THIS = gain }
				add_to_variable = { ROOT.relation@THIS = gain_int }
			}
			else_if = {
				limit = {
					ROOT = { has_country_flag = cancel_at_max_opinion@PREV }
				}
				add_to_temp_array = { cancel_befriend = THIS }
			}
		}
		else_if = { #decay
			limit = {
				check_variable = { ROOT.relation@THIS > 0 }
			}
			subtract_from_variable = { ROOT.relation@THIS = constant:improve_relation.decay }
			if = {
				limit = {
					check_variable = { ROOT.relation@THIS < 0.001 }
				}
				clear_variable = ROOT.relation@THIS
			}
		}
	}
	
	for_each_scope_loop = {
		array = resume_befriend
	
		if = {
			limit = {
				set_temp_variable = { max_befriend = constant:improve_relation.max }
				add_to_temp_variable = { max_befriend = ROOT.modifier@max_opinion_gain }
				
				OR = {
					NOT = { check_variable = { ROOT.relation@THIS > max_befriend } }
					check_variable = { ROOT.opinion@THIS < 100 }
				}
				
				NOT = { ROOT = { has_country_flag = improved_relation@PREV } }
			}
			
			if = {
				limit = {
					NOT = { is_in_array = { ROOT.befriend_targets = THIS } }
				}
				add_to_array = { ROOT.befriend_targets = THIS }
			}
			
			ROOT = {
				set_country_flag = improved_relation@PREV
				diplomatic_relation = {
					country = PREV
					relation = improve_relation
					active = yes
				}
			}
			
			# Replace decay opinion modifier with the one without
		
			remove_opinion_modifier = {
				target = ROOT
				modifier = improved_relation_decay
			}
			for_loop_effect = {
				end = ROOT.relation@THIS
				
				add_opinion_modifier = {
					target = ROOT
					modifier = improved_relation
				}
			}
		}
			
	}
		
	for_each_scope_loop = {
		array = cancel_befriend
		
		ROOT = {
			diplomatic_relation = {
				country = PREV
				relation = improve_relation
				active = no
			}
			clear_variable = relation_leftover@THIS
			#clr_country_flag = improved_relation@PREV - delayed removal 1 day later
			set_country_flag = { flag = has_cancel_improve_relation@PREV value = 1 days = 1 }
			
		}
		
		# Replace opinion modifier with the one with decay
		
		hidden_effect = {
			remove_opinion_modifier = {
				target = ROOT
				modifier = improved_relation
			}
			for_loop_effect = {
				end = ROOT.relation@THIS
				
				add_opinion_modifier = {
					target = ROOT
					modifier = improved_relation_decay
				}
			}
			set_temp_variable = { decay = constant:improve_relation.decay }
			for_loop_effect = {
				end = decay
				
				add_opinion_modifier = {
					target = ROOT
					modifier = improved_relation_decay
				}
			}
			
			country_event = { id = BI_on_action.5 days = 1 }
		}
	}
}

update_improve_relations_14 = { # ROOT = improver; THIS = improved with
	
	for_each_loop = {
		array = global.diplomatic_favours
	
		if = { #Update some favours periodically
			limit = {
				has_variable = ROOT.favour@var:v
				OR = {
					check_variable = { v = token:diplo_command_bonus }
					check_variable = { v = token:diplo_production_bonus }
					check_variable = { v = token:diplo_naval_bonus }
					check_variable = { v = token:diplo_resource_bonus }
					check_variable = { v = token:diplo_experience_bonus }
					check_variable = { v = token:diplo_research_bonus }
				}
			}
			set_temp_variable = { sender = THIS }
			set_temp_variable = { receiver = ROOT.favour@var:v }
			
			set_temp_variable = { on_add = 1 }
			set_temp_variable = { on_remove = 0 }
			meta_effect = {
				text = {
					[X] = yes
				}
				X = "[?v.GetTokenKey]"
			}
		}
	
	}
	
	for_each_scope_loop = {
		array = befriend_targets 
		
		if = {
			limit = {
				ROOT = { has_country_flag = improved_relation@PREV }
				cancel_improve_relation = yes
			}
			cancel_improve_relations = yes
		}
		
		if = {
			limit = {
				cancel_favour = yes
				any_of = {
					array = global.diplomatic_favours
					
					check_variable = { ROOT.favour@var:v = THIS }
				}
			}
			
			for_each_loop = {
				array = global.diplomatic_favours
			
				set_temp_variable = { sender = THIS }
				set_temp_variable = { receiver = ROOT }
				
				if = {
					limit = {
						check_variable = { ROOT.favour@var:v = THIS }
					}
					set_temp_variable = { on_add = 0 }
					set_temp_variable = { on_remove = 1 }
					meta_effect = {
						text = {
							[X] = yes
						}
						X = "[?v.GetTokenKey]"
					}
								
					if = {
						limit = {
							var:receiver = {
								check_variable = { favour@var:v = sender }
							}
						}
						var:receiver = { 
							clear_variable = favour@var:v 
							subtract_from_variable = { num_favour@var:sender = 1 }
						}
					}
					if = {
						limit = {
							var:sender = {
								check_variable = { favour@var:v = receiver }
							}
						}
						var:sender = { 
							clear_variable = favour@var:v 
							subtract_from_variable = { num_favour@var:receiver = 1 }
						}
					}
					
				}
			
			}
			if = {
				limit = {
					var:sender = {
						OR = {
							is_ai = no
							has_global_flag = favour_test_player
						}
					}
				}
				var:sender = {
					add_to_array = { notification = token:notif_favour_aborted }
					add_to_array = { notification_sender = receiver }
					add_to_array = { notification_target = sender }
				}
			}
			if = {
				limit = {
					var:receiver = {
						OR = {
							is_ai = no
							has_global_flag = favour_test_player
						}
					}
				}
				var:receiver = {
					add_to_array = { notification = token:notif_favour_aborted }
					add_to_array = { notification_sender = sender }
					add_to_array = { notification_target = receiver }
				}
			}
		}
		
	}
}

improve_relation_tooltip = {
	effect_tooltip = {
		
		set_temp_variable = { factor = ROOT.modifier@opinion_gain_monthly_factor }
		add_to_temp_variable = { factor = 1 }
		add_to_temp_variable = { factor = ROOT.befriend_factor@THIS }
		if = {
			limit = {
				is_ally_with = ROOT
			}
			add_to_temp_variable = { factor = ROOT.modifier@opinion_gain_monthly_ally_factor }
		}
		add_to_temp_variable = { factor = modifier@foreign_opinion_gain_monthly_factor }
		if = {
			limit = {
				has_same_government_as_root = yes
			}
			set_temp_variable = { gain = constant:improve_relation.same_ideology }

			set_temp_variable = { same = gain }
			subtract_from_temp_variable = { same = constant:improve_relation.different_ideology }
			
			add_to_temp_variable = { factor = ROOT.modifier@opinion_gain_monthly_same_ideology_factor }
			multiply_temp_variable = { gain = factor }
			add_to_temp_variable = { gain = ROOT.modifier@opinion_gain_monthly_same_ideology }
		}
		else = {
			set_temp_variable = { gain = constant:improve_relation.different_ideology }
			
			
			add_to_temp_variable = { factor = ROOT.modifier@opinion_gain_monthly_different_ideology_factor }
			multiply_temp_variable = { gain = factor }
			add_to_temp_variable = { gain = ROOT.modifier@opinion_gain_monthly_different_ideology }
		}
		add_to_temp_variable = { gain = ROOT.modifier@opinion_gain_monthly }
		add_to_temp_variable = { gain = modifier@foreign_opinion_gain_monthly }
		
		set_temp_variable = { base = constant:improve_relation.different_ideology }
		custom_effect_tooltip = IMPROVE_RELATION_MONTHLY_GAIN
		if = {
			limit = {
				check_variable = { same > 0 }
			}
			custom_effect_tooltip = {
				localization_key = IMPROVE_RELATION_TOOLTIP_ENTRY
				SOURCE = "Same Ideology"
				VAR = same
				FORMAT = "+="
			}
		}
		if = {
			limit = {
				NOT = { check_variable = { ROOT.modifier@opinion_gain_monthly_factor = 0 } }
			}
			custom_effect_tooltip = {
				localization_key = IMPROVE_RELATION_TOOLTIP_ENTRY
				SOURCE = opinion_gain_monthly_factor
				VAR = ROOT.modifier@opinion_gain_monthly_factor
				FORMAT = "+=%"
			}
		}
		if = {
			limit = {
				NOT = { check_variable = { ROOT.modifier@opinion_gain_monthly = 0 } }
			}
			custom_effect_tooltip = {
				localization_key = IMPROVE_RELATION_TOOLTIP_ENTRY
				SOURCE = opinion_gain_monthly
				VAR = ROOT.modifier@opinion_gain_monthly
				FORMAT = "+="
			}
		}
		if = {
			limit = {
				is_ally_with = ROOT
				NOT = { check_variable = { ROOT.modifier@opinion_gain_monthly_ally_factor = 0 } }
			}
			custom_effect_tooltip = {
				localization_key = IMPROVE_RELATION_TOOLTIP_ENTRY
				SOURCE = opinion_gain_monthly_ally_factor
				VAR = ROOT.modifier@opinion_gain_monthly_ally_factor
				FORMAT = "+=%"
			}
		}
		if = {
			limit = {
				has_same_government_as_root = yes
			}
			if = {
				limit = {
					NOT = { check_variable = { ROOT.modifier@opinion_gain_monthly_same_ideology_factor = 0 } }
				}
				custom_effect_tooltip = {
					localization_key = IMPROVE_RELATION_TOOLTIP_ENTRY
					SOURCE = opinion_gain_monthly_same_ideology_factor
					VAR = ROOT.modifier@opinion_gain_monthly_same_ideology_factor
					FORMAT = "+=%"
				}
			}
			if = {
				limit = {
					NOT = { check_variable = { ROOT.modifier@opinion_gain_monthly_same_ideology = 0 } }
				}
				custom_effect_tooltip = {
					localization_key = IMPROVE_RELATION_TOOLTIP_ENTRY
					SOURCE = opinion_gain_monthly_same_ideology
					VAR = ROOT.modifier@opinion_gain_monthly_same_ideology
					FORMAT = "+="
				}
			}
		}
		else = {
			if = {
				limit = {
					NOT = { check_variable = { ROOT.modifier@opinion_gain_monthly_different_ideology_factor = 0 } }
				}
				custom_effect_tooltip = {
					localization_key = IMPROVE_RELATION_TOOLTIP_ENTRY
					SOURCE = opinion_gain_monthly_different_ideology_factor
					VAR = ROOT.modifier@opinion_gain_monthly_different_ideology_factor
					FORMAT = "+=%"
				}
			}
			if = {
				limit = {
					NOT = { check_variable = { ROOT.modifier@opinion_gain_monthly_different_ideology = 0 } }
				}
				custom_effect_tooltip = {
					localization_key = IMPROVE_RELATION_TOOLTIP_ENTRY
					SOURCE = opinion_gain_monthly_different_ideology
					VAR = ROOT.modifier@opinion_gain_monthly_different_ideology
					FORMAT = "+="
				}
			}
		}
		if = {
			limit = {
				NOT = { check_variable = { modifier@foreign_opinion_gain_monthly_factor = 0 } }
			}
			custom_effect_tooltip = {
				localization_key = IMPROVE_RELATION_TOOLTIP_ENTRY
				SOURCE = foreign_opinion_gain_monthly_factor
				VAR = modifier@foreign_opinion_gain_monthly_factor
				FORMAT = "+=%"
			}
		}
		if = {
			limit = {
				NOT = { check_variable = { modifier@foreign_opinion_gain_monthly = 0 } }
			}
			custom_effect_tooltip = {
				localization_key = IMPROVE_RELATION_TOOLTIP_ENTRY
				SOURCE = foreign_opinion_gain_monthly
				VAR = modifier@foreign_opinion_gain_monthly
				FORMAT = "+="
			}
		}
		if = {
			limit = {
				NOT = { check_variable = { ROOT.befriend_factor@THIS = 0 } }
			}
			custom_effect_tooltip = {
				localization_key = IMPROVE_RELATION_TOOLTIP_ENTRY
				SOURCE = "Targeted Modifier towards this country"
				VAR = ROOT.befriend_factor@THIS
				FORMAT = "+=%"
			}
		}
		custom_effect_tooltip = space_TT

		set_temp_variable = { base = constant:improve_relation.max }
		set_temp_variable = { max_befriend = constant:improve_relation.max }
		add_to_temp_variable = { max_befriend = ROOT.modifier@max_opinion_gain }
		custom_effect_tooltip = IMPROVE_RELATION_MAX
		if = {
			limit = {
				NOT = { check_variable = { ROOT.modifier@max_opinion_gain = 0 } }
			}
			custom_effect_tooltip = {
				localization_key = IMPROVE_RELATION_TOOLTIP_ENTRY
				SOURCE = max_opinion_gain
				VAR = ROOT.modifier@max_opinion_gain
				FORMAT = "+0="
			}
		}
		custom_effect_tooltip = space_TT
	}
	
	set_temp_variable = { next_required_opinion = constant:improve_relation.favour_intervall }
	set_temp_variable = { per_pact_cost = constant:improve_relation.favour_intervall_stack }
	if = {
		limit = {
			check_variable = { num_favour@ROOT > 0 }
			set_temp_variable = { num_active_favour = num_favour@ROOT }
		}
		set_temp_variable = { factor = ROOT.modifier@pact_ramp_cost_factor }
		add_to_temp_variable = { factor = ROOT.favour_ramp_cost@THIS }
		add_to_temp_variable = { factor = 1 }
		multiply_temp_variable = { per_pact_cost = factor }
		multiply_temp_variable = { num_active_favour = per_pact_cost }
		add_to_temp_variable = { next_required_opinion = num_active_favour }
	}
	#YANDERE-TYPE CODING
	if = {
		limit = {
			check_variable = { ROOT.relation@THIS > next_required_opinion } 
		}
		add_to_temp_variable = { next_required_opinion = per_pact_cost }
		if = {
			limit = {
				check_variable = { ROOT.relation@THIS > next_required_opinion }
			}
			add_to_temp_variable = { next_required_opinion = per_pact_cost }
			if = {
				limit = {
					check_variable = { ROOT.relation@THIS > next_required_opinion }
				}
				add_to_temp_variable = { next_required_opinion = per_pact_cost }
				if = {
					limit = {
						check_variable = { ROOT.relation@THIS > next_required_opinion }
					}
					add_to_temp_variable = { next_required_opinion = per_pact_cost }
					if = {
						limit = {
							check_variable = { ROOT.relation@THIS > next_required_opinion }
						}
						add_to_temp_variable = { next_required_opinion = per_pact_cost }
						if = {
							limit = {
								check_variable = { ROOT.relation@THIS > next_required_opinion }
							}
							add_to_temp_variable = { next_required_opinion = per_pact_cost }
							if = {
								limit = {
									check_variable = { ROOT.relation@THIS > next_required_opinion }
								}
								add_to_temp_variable = { next_required_opinion = per_pact_cost }
								if = {
									limit = {
										check_variable = { ROOT.relation@THIS > next_required_opinion }
									}
									add_to_temp_variable = { next_required_opinion = per_pact_cost }
									if = {
										limit = {
											check_variable = { ROOT.relation@THIS > next_required_opinion }
										}
										add_to_temp_variable = { next_required_opinion = per_pact_cost }
									}
								}
							}
						}
					}
				}
			}
		}
	}
	
	set_temp_variable = { factor = modifier@pact_cost_factor }
	add_to_temp_variable = { factor = ROOT.favour_cost@THIS }
	add_to_temp_variable = { factor = 1 }
	multiply_temp_variable = { next_required_opinion = factor }
	
	set_temp_variable = { next_required_opinion_difference = next_required_opinion }
	subtract_from_temp_variable = { next_required_opinion_difference = ROOT.relation@THIS }
	
	
	set_temp_variable = { next_favour = next_required_opinion_difference }
	divide_temp_variable = { next_favour = gain }
	divide_temp_variable = { next_favour = 1000 }
	multiply_temp_variable = { next_favour = 1000 }
	add_to_temp_variable = { next_favour = 1 }
	if = {
		limit = {
			check_variable = { next_required_opinion < 100 }
		}
			
		custom_effect_tooltip = IMPROVE_RELATION_FAVOUR_GAIN
	}
	
	if = {
		limit = {
			check_variable = { next_required_opinion < 100 }
			check_variable = { next_required_opinion < max_befriend }
		}
			
		if = {
			limit = {
				ROOT = { has_country_flag = improved_relation@PREV }
			}
			custom_effect_tooltip = IMPROVE_RELATION_NEXT_FAVOUR_DATE
		}
		else = {
			custom_effect_tooltip = IMPROVE_RELATION_NEXT_FAVOUR_DATE_THEORETICAL
		}
	}
	if = {
		limit = {
			is_debug = yes
		}
		custom_effect_tooltip = "space_TT"
		custom_effect_tooltip = "------------------ DEBUG ------------------"
		custom_effect_tooltip = "[Root.GetTag] ROOT - [From.GetTag] FROM - [This.GetTag] THIS"
		custom_effect_tooltip = "ROOT.relation@THIS: [?ROOT.relation@THIS]"
		custom_effect_tooltip = "ROOT.relation_leftover@THIS: [?ROOT.relation_leftover@THIS]"
		custom_effect_tooltip = "next_required_opinion_difference: [?next_required_opinion_difference]"
		custom_effect_tooltip = "next_required_opinion: [?next_required_opinion]"
	}
}

request_favour = { # ROOT = requester; THIS = receiver; favour_v = favour
	
	var:receiver = {
		var:sender = {
			set_variable = { sent_favour_request@PREV = favour_v }
		}
		if = {
			limit = {
				OR = {
					is_ai = no
					has_global_flag = favour_test_player
				}
			}
			meta_effect = {
				text = {
					add_to_array = { alerts = token:alert_[X] }
				}
				X = "[?favour_v.GetTokenKey]"
			}
			add_to_array = { alerts_sender = ROOT }
			add_to_variable = { ui_topbar_update = 1 }
		}
		else = {
			hidden_effect = {
				ai_favour_acceptance = yes
					
				if = {
					limit = {
						check_variable = { positive > negative }
					}
					country_event = { id = BI_on_action.6 hours = 24 }
				}
				else = {
					country_event = { id = BI_on_action.7 hours = 24 }
				}
			}
		}
	}
	
}

accept_favour = {
	set_temp_variable = { original_sender = sender }
	set_temp_variable = { original_receiver = receiver }

	if = {
		limit = {
			var:original_sender = {
				has_variable = favour@var:favour_v
				set_temp_variable = { receiver = favour@var:favour_v }
			}
		}
			 
	### CANCEL EXISTING FAVOUR SENDER HAS WITH SOMEBODY ELSE
		
		#log = "CANCEL EXISTING FAVOUR SENDER HAS [?favour_v.GetTokenKey] of [?original_sender.GetTag] with [?receiver.GetTag]"
		set_temp_variable = { on_add = 0 }
		set_temp_variable = { on_remove = 1 }
		meta_effect = {
			text = {
				[X] = yes
			}
			X = "[?favour_v.GetTokenKey]"
		}
		
		var:sender = {
			var:receiver = {
				add_opinion_modifier = {
					target = PREV
					modifier = cancelled_favour
				}
			}
		}
	
		if = {
			limit = {
				var:sender = {
					check_variable = { favour@var:favour_v = receiver }
				}
			}
			var:sender = { 
				clear_variable = favour@var:favour_v 
				subtract_from_variable = { num_favour@var:receiver = 1 }
			}
		}
		if = {
			limit = {
				var:receiver = {
					check_variable = { favour@var:favour_v = sender }
				}
			}
			var:receiver = { 
				clear_variable = favour@var:favour_v 
				subtract_from_variable = { num_favour@var:sender = 1 }
			}
		}
		
		if = {
			limit = {
				var:receiver = {
					OR = {
						is_ai = no
						has_global_flag = favour_test_player
					}
				}
			}
			var:receiver = {
				add_to_array = { notification = token:notif_favour_cancelled }
				add_to_array = { notification_sender = sender }
				add_to_array = { notification_target = receiver }
			}
		}
	}
	
	if = {
		limit = {
			var:original_receiver = {
				has_variable = favour@var:favour_v
				set_temp_variable = { sender = favour@var:favour_v }
			}
		}
			
		set_temp_variable = { receiver = original_receiver }
		
	### CANCEL EXISTING FAVOUR RECEIVER HAS WITH SOMEBODY ELSE
		
		#log = "CANCEL EXISTING FAVOUR RECEIVER HAS [?favour_v.GetTokenKey] of [?receiver.GetTag] with [?sender.GetTag]"
		set_temp_variable = { on_add = 0 }
		set_temp_variable = { on_remove = 1 }
		meta_effect = {
			text = {
				[X] = yes
			}
			X = "[?favour_v.GetTokenKey]"
		}
		
		var:receiver = {
			var:sender = {
				add_opinion_modifier = {
					target = PREV
					modifier = cancelled_favour
				}
			}
		}
		
		if = {
			limit = {
				var:receiver = {
					check_variable = { favour@var:favour_v = sender }
				}
			}
			var:receiver = { 
				clear_variable = favour@var:favour_v 
				subtract_from_variable = { num_favour@var:sender = 1 }
			}
		}
		if = {
			limit = {
				var:sender = {
					check_variable = { favour@var:favour_v = receiver }
				}
			}
			var:sender = { 
				clear_variable = favour@var:favour_v 
				subtract_from_variable = { num_favour@var:receiver = 1 }
			}
		}
		
		if = {
			limit = {
				var:sender = {
					OR = {
						is_ai = no
						has_global_flag = favour_test_player
					}
				}
			}
			var:sender = {
				add_to_array = { notification = token:notif_favour_cancelled }
				add_to_array = { notification_sender = receiver }
				add_to_array = { notification_target = sender }
			}
		}
	}
	
	set_temp_variable = { sender = original_sender }
	set_temp_variable = { receiver = original_receiver }
	
	set_temp_variable = { on_add = 1 }
	set_temp_variable = { on_remove = 0 }
	meta_effect = {
		text = {
			[X] = yes
		}
		X = "[?favour_v.GetTokenKey]"
	}
	var:sender = { 
		set_variable = { favour@var:favour_v = receiver } 
		add_to_variable = { num_favour@var:receiver = 1 }
	}
	var:receiver = { 
		set_variable = { favour@var:favour_v = sender } 
		add_to_variable = { num_favour@var:sender = 1 }
	}
	
}

diplo_trade_bonus = {
	# var:sender
	# var:receiver
	
	if = { limit = { check_variable = { on_add = 1 } }
	
		## Effects when this option gets added
		
		custom_override_tooltip = {
			tooltip = diplo_trade_bonus_tt
				
			var:receiver = {
				var:sender = {
					add_relation_modifier = {
						target = PREV
						modifier = diplo_trade_bonus
					}
				}
			}
			var:sender = {
				var:receiver = {
					add_relation_modifier = {
						target = PREV
						modifier = diplo_trade_bonus
					}
				}
			}
		}
	}
	else_if = { limit = { check_variable = { on_remove = 1 } }
	
		## Effects when this option gets removed
		var:receiver = {
			var:sender = {
				remove_relation_modifier  = {
					target = PREV
					modifier = diplo_trade_bonus
				}
			}
		}
		var:sender = {
			var:receiver = {
				remove_relation_modifier  = {
					target = PREV
					modifier = diplo_trade_bonus
				}
			}
		}
	}
	
}

diplo_law_bonus = {
	# var:sender
	# var:receiver
	
	if = { limit = { check_variable = { on_add = 1 } }
	
		## Effects when this option gets added
		
		custom_override_tooltip = {
			tooltip = diplo_law_bonus_tt
			
			var:sender = {
				var:receiver = {
					add_to_array = { law_cost_share = PREV }
					set_variable = { law_cost_share_value@PREV = -0.4 }
				}
			}
			var:receiver = {
				var:sender = {
					add_to_array = { law_cost_share = PREV }
					set_variable = { law_cost_share_value@PREV = -0.4 }
				}
			}
		}
	}
	else_if = { limit = { check_variable = { on_remove = 1 } }
	
		## Effects when this option gets removed
		
		var:sender = {
			var:receiver = {
				remove_from_array = { law_cost_share = PREV }
				clear_variable = law_cost_share_value@PREV
			}
		}
		var:receiver = {
			var:sender = {
				remove_from_array = { law_cost_share = PREV }
				clear_variable = law_cost_share_value@PREV
			}
		}
	}
	
}

diplo_command_bonus = {
	# var:sender
	# var:receiver
	
	if = { limit = { check_variable = { on_add = 1 } }
	
		## Effects when this option gets added
	
		custom_override_tooltip = {
			tooltip = diplo_command_bonus_tt
			
			var:sender = {
				set_temp_variable = { sender_gain = command_power_daily }
				multiply_temp_variable = { sender_gain = 0.25 }
				clamp_temp_variable = { var = sender_gain min = 0.01 }
			}
			var:receiver = {
				set_temp_variable = { receiver_gain = command_power_daily }
				multiply_temp_variable = { receiver_gain = 0.25 }
				clamp_temp_variable = { var = receiver_gain min = 0.01 }
			}
			
			var:sender = {
				if = {
					limit = {
						NOT = {
							has_dynamic_modifier = {
								modifier = diplo_command_bonus
							}
						}
					}
					add_dynamic_modifier = {
						modifier = diplo_command_bonus
					}
				}
				set_variable = { diplo_command_bonus = receiver_gain }
			}
			var:receiver = {
				if = {
					limit = {
						NOT = {
							has_dynamic_modifier = {
								modifier = diplo_command_bonus
							}
						}
					}
					add_dynamic_modifier = {
						modifier = diplo_command_bonus
					}
				}
				set_variable = { diplo_command_bonus = sender_gain }
			}
			
		}
	}
	else_if = { limit = { check_variable = { on_remove = 1 } }
	
		## Effects when this option gets removed
	
		var:sender = {
			if = {
				limit = {
					has_dynamic_modifier = {
						modifier = diplo_command_bonus
					}
				}
				remove_dynamic_modifier = {
					modifier = diplo_command_bonus
				}
			}
			clear_variable = diplo_command_bonus
		}
		var:receiver = {
			if = {
				limit = {
					has_dynamic_modifier = {
						modifier = diplo_command_bonus
					}
				}
				remove_dynamic_modifier = {
					modifier = diplo_command_bonus
				}
			}
			clear_variable = diplo_command_bonus
		}
	}
	else_if = { limit = { check_variable = { on_active = 1 } }
		custom_effect_tooltip = diplo_command_bonus_active
	}
}

diplo_production_bonus = {
	# var:sender
	# var:receiver
	
	if = { limit = { check_variable = { on_add = 1 } }
	
		## Effects when this option gets added
	
		custom_override_tooltip = {
			tooltip = diplo_production_bonus_tt
			var:receiver = {
				var:sender = {
					set_temp_variable = { sender_gain = PREV.modifier@industrial_capacity_factory  }
					subtract_from_temp_variable = { sender_gain = PREV.diplo_production_bonus }
					subtract_from_temp_variable = { sender_gain = modifier@industrial_capacity_factory }
					multiply_temp_variable = { sender_gain = 0.5 }
					clamp_temp_variable = { var = sender_gain min = 0.01 max = 0.1 }
					set_variable = { diplo_production_bonus = sender_gain }
					
					if = {
						limit = {
							NOT = {
								has_dynamic_modifier = {
									modifier = diplo_production_bonus
								}
							}
						}
						add_dynamic_modifier = {
							modifier = diplo_production_bonus
						}
					}
				}
			}
			var:sender = {
				var:receiver = {
					set_temp_variable = { receiver_gain = PREV.modifier@industrial_capacity_factory  }
					subtract_from_temp_variable = { receiver_gain = PREV.diplo_production_bonus }
					subtract_from_temp_variable = { receiver_gain = modifier@industrial_capacity_factory }
					multiply_temp_variable = { receiver_gain = 0.5 }
					clamp_temp_variable = { var = receiver_gain min = 0.01 max = 0.1 }
					set_variable = { diplo_production_bonus = receiver_gain }
					
					if = {
						limit = {
							NOT = {
								has_dynamic_modifier = {
									modifier = diplo_production_bonus
								}
							}
						}
						add_dynamic_modifier = {
							modifier = diplo_production_bonus
						}
					}
				}
			}
		}
	}
	else_if = { limit = { check_variable = { on_remove = 1 } }
	
		## Effects when this option gets removed
		
		var:sender = {
			if = {
				limit = {
					has_dynamic_modifier = {
						modifier = diplo_production_bonus
					}
				}
				remove_dynamic_modifier = {
					modifier = diplo_production_bonus
				}
			}
			clear_variable = diplo_production_bonus
		}
		var:receiver = {
			if = {
				limit = {
					has_dynamic_modifier = {
						modifier = diplo_production_bonus
					}
				}
				remove_dynamic_modifier = {
					modifier = diplo_production_bonus
				}
			}
			clear_variable = diplo_production_bonus
		}
	}
	else_if = { limit = { check_variable = { on_active = 1 } }
		custom_effect_tooltip = diplo_production_bonus_active
	}
}

diplo_naval_bonus = {
	# var:sender
	# var:receiver
	
	if = { limit = { check_variable = { on_add = 1 } }
	
		## Effects when this option gets added
	
		custom_override_tooltip = {
			tooltip = diplo_naval_bonus_tt
			var:receiver = {
				var:sender = {
					set_temp_variable = { sender_gain = PREV.modifier@industrial_capacity_dockyard  }
					subtract_from_temp_variable = { sender_gain = PREV.diplo_naval_bonus }
					subtract_from_temp_variable = { sender_gain = modifier@industrial_capacity_dockyard }
					multiply_temp_variable = { sender_gain = 0.5 }
					clamp_temp_variable = { var = sender_gain min = 0.01 max = 0.1 }
					set_variable = { diplo_naval_bonus = sender_gain }
					
					if = {
						limit = {
							NOT = {
								has_dynamic_modifier = {
									modifier = diplo_naval_bonus
								}
							}
						}
						add_dynamic_modifier = {
							modifier = diplo_naval_bonus
						}
					}
				}
			}
			var:sender = {
				var:receiver = {
					set_temp_variable = { receiver_gain = PREV.modifier@industrial_capacity_dockyard  }
					subtract_from_temp_variable = { receiver_gain = PREV.diplo_naval_bonus }
					subtract_from_temp_variable = { receiver_gain = modifier@industrial_capacity_dockyard }
					multiply_temp_variable = { receiver_gain = 0.5 }
					clamp_temp_variable = { var = receiver_gain min = 0.01 max = 0.1 }
					set_variable = { diplo_naval_bonus = receiver_gain }
					
					if = {
						limit = {
							NOT = {
								has_dynamic_modifier = {
									modifier = diplo_naval_bonus
								}
							}
						}
						add_dynamic_modifier = {
							modifier = diplo_naval_bonus
						}
					}
				}
			}
		}
	}
	else_if = { limit = { check_variable = { on_remove = 1 } }
	
		## Effects when this option gets removed
		
		var:sender = {
			if = {
				limit = {
					has_dynamic_modifier = {
						modifier = diplo_naval_bonus
					}
				}
				remove_dynamic_modifier = {
					modifier = diplo_naval_bonus
				}
			}
			clear_variable = diplo_naval_bonus
		}
		var:receiver = {
			if = {
				limit = {
					has_dynamic_modifier = {
						modifier = diplo_naval_bonus
					}
				}
				remove_dynamic_modifier = {
					modifier = diplo_naval_bonus
				}
			}
			clear_variable = diplo_naval_bonus
		}
	}
	else_if = { limit = { check_variable = { on_active = 1 } }
		custom_effect_tooltip = diplo_naval_bonus_active
	}
	
}
diplo_resource_bonus = {
	# var:sender
	# var:receiver
	
	if = { limit = { check_variable = { on_add = 1 } }
	
		## Effects when this option gets added
	
		custom_override_tooltip = {
			tooltip = diplo_resource_bonus_tt
			
			var:receiver = {
				var:sender = {
					set_temp_variable = { sender_gain = PREV.modifier@resources_factor }
					subtract_from_temp_variable = { sender_gain = PREV.diplo_resource_bonus }
					multiply_temp_variable = { sender_gain = 0.2 }
					clamp_temp_variable = { var = sender_gain min = 0.01 max = 0.10 }
					set_variable = { diplo_resource_bonus = sender_gain }
				
					if = {
						limit = {
							NOT = {
								has_dynamic_modifier = {
									modifier = diplo_resource_bonus
								}
							}
						}
						add_dynamic_modifier = {
							modifier = diplo_resource_bonus
						}
					}
				}
			}
			var:sender = {
				var:receiver = {
					set_temp_variable = { receiver_gain = PREV.modifier@resources_factor }
					subtract_from_temp_variable = { receiver_gain = PREV.diplo_resource_bonus }
					multiply_temp_variable = { receiver_gain = 0.2 }
					clamp_temp_variable = { var = receiver_gain min = 0.01 max = 0.10 }
					set_variable = { diplo_resource_bonus = receiver_gain }
				
					if = {
						limit = {
							NOT = {
								has_dynamic_modifier = {
									modifier = diplo_resource_bonus
								}
							}
						}
						add_dynamic_modifier = {
							modifier = diplo_resource_bonus
						}
					}
				}
			}
		}
	}
	else_if = { limit = { check_variable = { on_remove = 1 } }
	
		## Effects when this option gets removed
		
		var:sender = {
			if = {
				limit = {
					has_dynamic_modifier = {
						modifier = diplo_resource_bonus
					}
				}
				remove_dynamic_modifier = {
					modifier = diplo_resource_bonus
				}
			}
			clear_variable = diplo_resource_bonus
		}
		var:receiver = {
			if = {
				limit = {
					has_dynamic_modifier = {
						modifier = diplo_resource_bonus
					}
				}
				remove_dynamic_modifier = {
					modifier = diplo_resource_bonus
				}
			}
			clear_variable = diplo_resource_bonus
		}
	}
	else_if = { limit = { check_variable = { on_active = 1 } }
		custom_effect_tooltip = diplo_resource_bonus_active
	}
	
}

diplo_experience_bonus = {
	# var:sender
	# var:receiver
	
	if = { limit = { check_variable = { on_add = 1 } }
	
		## Effects when this option gets added
	
		custom_override_tooltip = {
			tooltip = diplo_experience_bonus_tt
			
			var:receiver = {
				var:sender = {
					set_temp_variable = { xp_army = PREV.modifier@experience_gain_army }
					multiply_temp_variable = { xp_army = 0.35 }
					clamp_temp_variable = { var = xp_army min = 0 }
					set_temp_variable = { xp_air = PREV.modifier@experience_gain_air }
					multiply_temp_variable = { xp_air = 0.35 }
					clamp_temp_variable = { var = xp_air min = 0 }
					set_temp_variable = { xp_navy = PREV.modifier@experience_gain_navy }
					multiply_temp_variable = { xp_navy = 0.35 }
					clamp_temp_variable = { var = xp_navy min = 0 }
					set_variable = { diplo_experience_bonus_army = xp_army }
					set_variable = { diplo_experience_bonus_air = xp_air }
					set_variable = { diplo_experience_bonus_navy = xp_navy }
					
					if = {
						limit = {
							NOT = {
								has_dynamic_modifier = {
									modifier = diplo_experience_bonus
								}
							}
						}
						add_dynamic_modifier = {
							modifier = diplo_experience_bonus
						}
					}
				}
			}
			var:sender = {
				var:receiver = {
					set_temp_variable = { xp_army = PREV.modifier@experience_gain_army }
					multiply_temp_variable = { xp_army = 0.35 }
					clamp_temp_variable = { var = xp_army min = 0 }
					set_temp_variable = { xp_air = PREV.modifier@experience_gain_air }
					multiply_temp_variable = { xp_air = 0.35 }
					clamp_temp_variable = { var = xp_air min = 0 }
					set_temp_variable = { xp_navy = PREV.modifier@experience_gain_navy }
					multiply_temp_variable = { xp_navy = 0.35 }
					clamp_temp_variable = { var = xp_navy min = 0 }
					set_variable = { diplo_experience_bonus_army = xp_army }
					set_variable = { diplo_experience_bonus_air = xp_air }
					set_variable = { diplo_experience_bonus_navy = xp_navy }
					
					if = {
						limit = {
							NOT = {
								has_dynamic_modifier = {
									modifier = diplo_experience_bonus
								}
							}
						}
						add_dynamic_modifier = {
							modifier = diplo_experience_bonus
						}
					}
				}
			}
		}
	}
	else_if = { limit = { check_variable = { on_remove = 1 } }
	
		## Effects when this option gets removed
		
		var:sender = {
			if = {
				limit = {
					has_dynamic_modifier = {
						modifier = diplo_experience_bonus
					}
				}
				remove_dynamic_modifier = {
					modifier = diplo_experience_bonus
				}
			}
			clear_variable = diplo_experience_bonus_army
			clear_variable = diplo_experience_bonus_air
			clear_variable = diplo_experience_bonus_navy
		}
		var:receiver = {
			if = {
				limit = {
					has_dynamic_modifier = {
						modifier = diplo_experience_bonus
					}
				}
				remove_dynamic_modifier = {
					modifier = diplo_experience_bonus
				}
			}
			clear_variable = diplo_experience_bonus_army
			clear_variable = diplo_experience_bonus_air
			clear_variable = diplo_experience_bonus_navy
		}
	}
	else_if = { limit = { check_variable = { on_active = 1 } }
		custom_effect_tooltip = diplo_experience_bonus_active
	}
}

diplo_license_bonus = {
	# var:sender
	# var:receiver
	
	if = { limit = { check_variable = { on_add = 1 } }
	
		## Effects when this option gets added
		custom_override_tooltip = {
			tooltip = diplo_license_bonus_tt
				
			var:receiver = {
				var:sender = {
					add_relation_modifier = {
						target = PREV
						modifier = diplo_license_bonus
					}
				}
			}
			var:sender = {
				var:receiver = {
					add_relation_modifier = {
						target = PREV
						modifier = diplo_license_bonus
					}
				}
			}
		}
	}
	else_if = { limit = { check_variable = { on_remove = 1 } }
	
		## Effects when this option gets removed
		
		var:receiver = {
			var:sender = {
				remove_relation_modifier = {
					target = PREV
					modifier = diplo_license_bonus
				}
			}
		}
		var:sender = {
			var:receiver = {
				remove_relation_modifier = {
					target = PREV
					modifier = diplo_license_bonus
				}
			}
		}
	}
	
}

diplo_intelligence_bonus = {
	# var:sender
	# var:receiver
	
	if = { limit = { check_variable = { on_add = 1 } }
	
		## Effects when this option gets added
		
		custom_override_tooltip = {
			tooltip = diplo_intelligence_bonus_tt
			
			var:receiver = {
				var:sender = {
					add_to_array = { agency_cost_share = PREV }
					set_variable = { agency_cost_share_value@PREV = -0.25 }
				}
			}
			var:sender = {
				var:receiver = {
					add_to_array = { agency_cost_share = PREV }
					set_variable = { agency_cost_share_value@PREV = -0.25 }
				}
			}
		}
	}
	else_if = { limit = { check_variable = { on_remove = 1 } }
	
		## Effects when this option gets removed
		
		var:receiver = {
			var:sender = {
				remove_from_array = { agency_cost_share = PREV }
				clear_variable = agency_cost_share_value@PREV
			}
		}
		var:sender = {
			var:receiver = {
				remove_from_array = { agency_cost_share = PREV }
				clear_variable = agency_cost_share_value@PREV
			}
		}
	}
	
}

diplo_research_bonus = {
	# var:sender
	# var:receiver
	
	if = { limit = { check_variable = { on_add = 1 } }
	
		## Effects when this option gets added
		
		custom_override_tooltip = {
			tooltip = diplo_research_bonus_tt
			
			var:receiver = {
				var:sender = {
					set_temp_variable = { sender_gain = PREV.num_researched_technologies }
					divide_temp_variable = { sender_gain = 10000 }
					clamp_temp_variable = { var = sender_gain max = 0.1 }
					set_variable = { diplo_research_bonus = sender_gain }
					
					if = {
						limit = {
							NOT = {
								has_dynamic_modifier = {
									modifier = diplo_research_bonus
								}
							}
						}
						add_dynamic_modifier = {
							modifier = diplo_research_bonus
						}
					}
				}
			}
			var:sender = {
				var:receiver = {
					set_temp_variable = { receiver_gain = PREV.num_researched_technologies }
					divide_temp_variable = { receiver_gain = 10000 }
					clamp_temp_variable = { var = receiver_gain max = 0.1 }
					set_variable = { diplo_research_bonus = receiver_gain }
					
					if = {
						limit = {
							NOT = {
								has_dynamic_modifier = {
									modifier = diplo_research_bonus
								}
							}
						}
						add_dynamic_modifier = {
							modifier = diplo_research_bonus
						}
					}
				}
			}
		}
	}
	else_if = { limit = { check_variable = { on_remove = 1 } }
	
		## Effects when this option gets removed
		
		var:receiver = {
			var:sender = {
				if = {
					limit = {
						has_dynamic_modifier = {
							modifier = diplo_research_bonus
						}
					}
					remove_dynamic_modifier = {
						modifier = diplo_research_bonus
					}
				}
				clear_variable = diplo_research_bonus
			}
		}
		var:sender = {
			var:receiver = {
				if = {
					limit = {
						has_dynamic_modifier = {
							modifier = diplo_research_bonus
						}
					}
					remove_dynamic_modifier = {
						modifier = diplo_research_bonus
					}
				}
				clear_variable = diplo_research_bonus
			}
		}
	}
	else_if = { limit = { check_variable = { on_active = 1 } }
		custom_effect_tooltip = diplo_research_bonus_active
	}
}


THIS_add_opinion_to_PREV = {
	custom_override_tooltip = {
		tooltip = THIS_add_opinion_to_PREV
		
		round_temp_variable = opinion

		set_temp_variable = { max_befriend = constant:improve_relation.max }
		add_to_temp_variable = { max_befriend = ROOT.modifier@max_opinion_gain }
		set_temp_variable = { max_change = max_befriend }
		subtract_from_temp_variable = { max_change = ROOT.relation@THIS }
		clamp_temp_variable = { var = opinion max = max_change }
		
		if = {
			limit = {
				NOT = { is_in_array = { PREV.befriend_targets = THIS } }
			}
			add_to_array = { PREV.befriend_targets = THIS }
		}
		
		if = {
			limit = {
				PREV = { has_country_flag = improved_relation@PREV }
			}
			for_loop_effect = {
				end = opinion
			
				add_opinion_modifier = {
					target = PREV
					modifier = improved_relation
				}
			}
		}
		else = {
			for_loop_effect = {
				end = opinion
			
				add_opinion_modifier = {
					target = PREV
					modifier = improved_relation_decay
				}
			}
		}
		add_to_variable = { PREV.relation@THIS = opinion }
	}
}

ROOT_request_favour_with_THIS = {
	set_temp_variable = { ai_always_accept = 1 }
	
	set_temp_variable = { sender = ROOT }
	set_temp_variable = { receiver = THIS }
	
	custom_override_tooltip = {
		tooltip = ROOT_request_favour_with_THIS
			
		request_favour = yes
	}
}

THIS_request_favour_with_PREV = {
	set_temp_variable = { ai_always_accept = 1 }
	
	set_temp_variable = { sender = THIS }
	set_temp_variable = { receiver = PREV }
	
	custom_override_tooltip = {
		tooltip = THIS_request_favour_with_PREV
			
		request_favour = yes
	}
}

ROOT_set_favour_with_THIS = {
	set_temp_variable = { sender = ROOT }
	set_temp_variable = { receiver = THIS }
	
	custom_override_tooltip = {
		tooltip = ROOT_set_favour_with_THIS
		
		accept_favour = yes
	}
}

THIS_set_favour_with_PREV = {
	set_temp_variable = { sender = THIS }
	set_temp_variable = { receiver = PREV }
	
	custom_override_tooltip = {
		tooltip = THIS_set_favour_with_PREV
		
		accept_favour = yes
	}
}
