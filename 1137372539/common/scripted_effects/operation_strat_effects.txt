

update_operation_ai = {
	
	if = {
		limit = {
			ai_can_run_operations = yes
		}
			
		# old target is no longer relevant
		if = {
			limit = {
				NOT = { check_variable = { generic_operation_target = 0 } }
				var:generic_operation_target = {
					OR = {
						exists = no
						has_capitulated = yes
						is_ally_with = PREV
					}
				}
			}
			clear_variable = generic_operation_target
		}
		
		ai_custom_operation_and_target_weight = yes
		clear_array = ai_operation_targets

		# pick an operation target
		get_highest_scored_country = {
			scorer = ai_generic_operation_target_scorer
			var = generic_operation_target
		}
		add_to_array = { ai_operation_targets = generic_operation_target }
		
		#log = "[?generic_operation_target.GetName] generic_operation_target"
		# this variable will be our limiting factor for actually doing operations
		
		# check if we have any operatives that are captured
		# find the captor so they can be rescued
		set_temp_variable = { captor = 0 }
		
		every_operative = {
			limit = { is_operative_captured = yes }
			add_to_temp_variable = { min_needed_operative_for_operations = 1 }
			if = {
				limit = { check_variable = { captor = 0 } }
				set_temp_variable = { captor = operative_captor }
			}
		}
		set_variable = { rescue_operative_from = 0 }
		if = {
			limit = { NOT = { check_variable = { captor = 0 } } }
			set_variable = { rescue_operative_from = captor } # used in ai strat generic_operation_ai_rescue
			add_to_temp_variable = { min_needed_operative_for_operations = 2 }
		}
		
		
		# if we have too few of operatives clear operative target
		set_temp_variable = { t = min_needed_operative_for_operations }
		subtract_from_temp_variable = { t = 2 }
		if = {
			limit = { 
				num_of_operatives < t 
			}
			set_variable = { generic_operation_target = 0 }
		}
		
		#log = "[?min_needed_operative_for_operations] min_needed_operative_for_operations"
		if = {
			limit = {
				#num_of_operatives > min_needed_operative_for_operations
				NOT = { check_variable = { generic_operation_target = 0 }}
			}
			
			set_temp_variable = { num_operations = num_of_operatives }
			subtract_from_temp_variable = { num_operations = min_needed_operative_for_operations }
			divide_temp_variable = { num_operations = 2 }
			round_temp_variable = num_operations
			clamp_temp_variable = { var = num_operations min = 1 max = 3 }
			#log = "[?num_operations] num_operations"
			
			var:generic_operation_target = {
				add_to_temp_array = { operation_types = token:operation_sabotage_fuel }
				add_to_temp_array = { operation_types_scores = mtth:operation_sabotage_fuel }
				
				add_to_temp_array = { operation_types = token:operation_steal_tech_civilian }
				add_to_temp_array = { operation_types_scores = mtth:operation_steal_tech_civilian }
				
				add_to_temp_array = { operation_types = token:operation_sabotage_oil }
				add_to_temp_array = { operation_types_scores = mtth:operation_sabotage_oil }
				
				add_to_temp_array = { operation_types = token:operation_target_attache }
				add_to_temp_array = { operation_types_scores = mtth:operation_target_attache }
				
				add_to_temp_array = { operation_types = token:operation_sabotage_radar }
				add_to_temp_array = { operation_types_scores = mtth:operation_sabotage_radar }
				
				add_to_temp_array = { operation_types = token:operation_strengthen_resistance }
				add_to_temp_array = { operation_types_scores = mtth:operation_strengthen_resistance }
				
				add_to_temp_array = { operation_types = token:operation_strengthen_society }
				add_to_temp_array = { operation_types_scores = mtth:operation_strengthen_society }
			}
			
			for_each_loop = {
				array = operation_types
				break = none
				index = entry
			
				for_each_loop = { array = operation_types_score_sorted value = s

					if = { limit = { check_variable = { operation_types_scores^entry > s } }

						add_to_temp_array = { array = operation_types_sorted index = i value = v }
						add_to_temp_array = { array = operation_types_score_sorted index = i value = operation_types_scores^entry }
						set_temp_variable = { break = 1 }
					}
				}

				if = { limit = { check_variable = { break = 0 } }
					
					add_to_temp_array = { array = operation_types_sorted value = v }
					add_to_temp_array = { array = operation_types_score_sorted value = operation_types_scores^entry }
				}
				else = { set_temp_variable = { break = 0 } }
						
			}
			clear_array = ai_operations
			
			for_each_loop = {
				array = operation_types_sorted
				
				if = {
					limit = {
						check_variable = { num_operations > 0 }
					}
					subtract_from_temp_variable = { num_operations = 1 }
					
					add_to_array = { ai_operations = v }
				}
				#log = "[?v.GetTokenKey] [?operation_types_score_sorted^i] SCORE"
			}
			
			#log = "[?ai_operations^num] ai_operations^num"
		}
		
		ai_score_resistance_areas = yes
	}
	else = {
		clear_variable = generic_operation_target
		clear_array = ai_operation_targets
	}
	
}

ai_custom_operation_and_target_weight = {

	if = {
		limit = {
			tag = GER
		}
		
		if = {
			limit = {
				FRA = { has_capitulated = yes }
			}
			add_to_temp_variable = { operation_target@ENG = 500 }
			add_to_temp_variable = { operation_sabotage_fuel@ENG = 10 }
		}
		else = {
			add_to_temp_variable = { operation_target@FRA = 50 }
		}
		
		if = {
			limit = {
				has_war_with = SOV
			}
			add_to_temp_variable = { operation_target@SOV = 500 }
			
			add_to_temp_variable = { operation_sabotage_oil@SOV = 15 }
			add_to_temp_variable = { operation_sabotage_fuel@SOV = 10 }
		}
		
	}
	else_if = {
		limit = {
			tag = SOV
		}
		
		if = {
			limit = {
				has_war_with = GER
			}
			add_to_temp_variable = { operation_target@GER = 500 }
			
			add_to_temp_variable = { operation_strengthen_resistance@GER = 10 }
			
		}
	}
	else_if = {
		limit = {
			tag = ENG
		}
		
		add_to_temp_variable = { operation_target@ITA = 50 }
		
		if = {
			limit = {
				has_war_with = GER
				OR = {
					GER = { has_war_with = SOV }
					date > 1941.1.1
				}
			}
			
			add_to_temp_variable = { operation_strengthen_resistance@GER = 2 }
			add_to_temp_variable = { operation_strengthen_society@GER = 2 }
			
		}
	}
}

ai_score_resistance_areas = {

	for_each_loop = {
		array = intel_networks
		value = resistance_target

		clear_temp_array = intel_resistance_asset_area_score
		for_each_scope_loop = {
			array = intel_resistance_asset_area@var:resistance_target
			
			add_to_temp_array = { intel_resistance_asset_area_score = mtth:resistance_area_score }
		}

		clear_temp_array = intel_area_sorted
		clear_temp_array = intel_area_score_sorted
		for_each_loop = {
			array = intel_resistance_asset_area@var:resistance_target
			break = none
			index = entry
			
			for_each_loop = { array = intel_area_score_sorted value = s

				if = { limit = { check_variable = { intel_resistance_asset_area_score^entry > s } }

					add_to_temp_array = { array = intel_area_sorted index = i value = v }
					add_to_temp_array = { array = intel_area_score_sorted index = i value = intel_resistance_asset_area_score^entry }
					set_temp_variable = { break = 1 }
				}
			}

			if = { limit = { check_variable = { break = 0 } }
				
				add_to_temp_array = { array = intel_area_sorted value = v }
				add_to_temp_array = { array = intel_area_score_sorted value = intel_resistance_asset_area_score^entry }
			}
			else = { set_temp_variable = { break = 0 } }
					
		}
		
		#for_each_loop = {
		#	array = intel_area_sorted
		#	
		#	log = "[?v.GetName] | Score: [?intel_area_score_sorted^i]"
		#}
		set_variable = { selected_resistance_area@var:resistance_target = intel_area_sorted^0 }
	}
}

# GER target SOV oil
# ENG / USA target ROM oil