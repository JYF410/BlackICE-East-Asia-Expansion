
#------------------------------ diplo_action_acceptance, diplo_action_desire
# improve_relation 				# befriend-opinion
# lend_lease
# request_lend_lease
# guarantee
# non_aggression_pact 			#befriend-antagonize 
# military_access				#befriend-antagonize 
# offer_military_access
# docking_rights				#befriend-antagonize 
# offer_docking_rights
# join_faction					#alliance-antagonize 
# offer_join_faction
# justifying_war_goal
# declare_war
# join_allies
# call_allies
# send_expeditionary_force
# return_expeditionary_forces
# request_expeditionary_forces

# asking_foreign_garrison
# request_foreign_manpower
# cancel_foreign_manpower

# request_access_to_licence_production	#befriend-antagonize
# request_licensed_production
# cancel_licensed_production # this one is disabled in BICE due to UI issues
# market_access_rights

ai_static_diplomacy_strategies = {
	# define faction -> faction diplomatic ai behaviour here
	# strategies get applied for every country of ROOT faction
	# towards every country of the *_target tag faction
	# this strictly only works if both ROOT and target are in faction
	
	# preset alliance leaders. if faction leader changes it will automatically update
	add_to_array = { global.ai_faction_diplo_leader = GER }
	add_to_array = { global.ai_faction_diplo_leader = ENG }
	add_to_array = { global.ai_faction_diplo_leader = JAP }
	add_to_array = { global.ai_faction_diplo_leader = CHI }
	add_to_array = { global.ai_faction_diplo_leader = SOV }
	
	GER = {
		add_to_array = { ai_faction_desire_target = JAP }
		add_to_array = { ai_faction_desire_action = token:military_access }
		add_to_array = { ai_faction_desire_value = -5000 }
		
		add_to_array = { ai_faction_desire_target = JAP }
		add_to_array = { ai_faction_desire_action = token:docking_rights }
		add_to_array = { ai_faction_desire_value = -5000 }
		
		#add_to_array = { ai_faction_desire_target = JAP }
		#add_to_array = { ai_faction_desire_action = token:embargo }
		#add_to_array = { ai_faction_desire_value = -5000 }
		
		add_to_array = { ai_faction_desire_target = SOV }
		add_to_array = { ai_faction_desire_action = token:military_access }
		add_to_array = { ai_faction_desire_value = -5000 }
		
		add_to_array = { ai_faction_desire_target = SOV }
		add_to_array = { ai_faction_desire_action = token:docking_rights }
		add_to_array = { ai_faction_desire_value = -5000 }
		
		add_to_array = { ai_faction_acceptance_target = SOV }
		add_to_array = { ai_faction_acceptance_action = token:market_access_rights }
		add_to_array = { ai_faction_acceptance_value = -500 }
	}
	
	ENG = {
		add_to_array = { ai_faction_desire_target = SOV }
		add_to_array = { ai_faction_desire_action = token:military_access }
		add_to_array = { ai_faction_desire_value = -5000 }
		
		add_to_array = { ai_faction_desire_target = SOV }
		add_to_array = { ai_faction_desire_action = token:docking_rights }
		add_to_array = { ai_faction_desire_value = -5000 }
		
		add_to_array = { ai_faction_desire_target = CHI }
		add_to_array = { ai_faction_desire_action = token:military_access }
		add_to_array = { ai_faction_desire_value = -5000 }
		
		add_to_array = { ai_faction_desire_target = CHI }
		add_to_array = { ai_faction_desire_action = token:docking_rights }
		add_to_array = { ai_faction_desire_value = -5000 }
	}
	
	JAP = {
		add_to_array = { ai_faction_desire_target = GER }
		add_to_array = { ai_faction_desire_action = token:military_access }
		add_to_array = { ai_faction_desire_value = -5000 }
		
		add_to_array = { ai_faction_desire_target = GER }
		add_to_array = { ai_faction_desire_action = token:docking_rights }
		add_to_array = { ai_faction_desire_value = -5000 }
		
		#add_to_array = { ai_faction_desire_target = GER }
		#add_to_array = { ai_faction_desire_action = token:embargo }
		#add_to_array = { ai_faction_desire_value = -5000 }
	}
	
	CHI = {
		add_to_array = { ai_faction_acceptance_target = ENG }
		add_to_array = { ai_faction_acceptance_action = token:military_access }
		add_to_array = { ai_faction_acceptance_value = -500 }
		
		add_to_array = { ai_faction_acceptance_target = ENG }
		add_to_array = { ai_faction_acceptance_action = token:docking_rights }
		add_to_array = { ai_faction_acceptance_value = -500 }
		
		add_to_array = { ai_faction_acceptance_target = SOV }
		add_to_array = { ai_faction_acceptance_action = token:military_access }
		add_to_array = { ai_faction_acceptance_value = -500 }
		
		add_to_array = { ai_faction_acceptance_target = SOV }
		add_to_array = { ai_faction_acceptance_action = token:docking_rights }
		add_to_array = { ai_faction_acceptance_value = -500 }
		
		add_to_array = { ai_faction_desire_target = ENG }
		add_to_array = { ai_faction_desire_action = token:docking_rights }
		add_to_array = { ai_faction_desire_value = -5000 }
		
	}
	
	SOV = {
		add_to_array = { ai_faction_acceptance_target = ENG }
		add_to_array = { ai_faction_acceptance_action = token:military_access }
		add_to_array = { ai_faction_acceptance_value = -500 }
		
		add_to_array = { ai_faction_acceptance_target = ENG }
		add_to_array = { ai_faction_acceptance_action = token:docking_rights }
		add_to_array = { ai_faction_acceptance_value = -500 }
		
		add_to_array = { ai_faction_acceptance_target = GER }
		add_to_array = { ai_faction_acceptance_action = token:military_access }
		add_to_array = { ai_faction_acceptance_value = -250 }
		
		add_to_array = { ai_faction_acceptance_target = GER }
		add_to_array = { ai_faction_acceptance_action = token:docking_rights }
		add_to_array = { ai_faction_acceptance_value = -250 }
		
		add_to_array = { ai_faction_acceptance_target = GER }
		add_to_array = { ai_faction_acceptance_action = token:market_access_rights }
		add_to_array = { ai_faction_acceptance_value = -500 }
	}
	
}

ai_update_on_joining_faction = {
	if = {
		limit = {
			NOT = { check_variable = { leading_country = joining_country } }
		}
		var:leading_country = {
			var:joining_country = {
				for_each_scope_loop = {
					array = PREV.faction_members
					
					if = {
						limit = {
							NOT = { tag = var:joining_country }
						}
							
						var:joining_country = {
							diplomatic_relation = {
								country = PREV
								relation = military_access
								active = no
							}
							diplomatic_relation = {
								country = PREV
								relation = docking_rights
								active = no
							}
						}
						
						diplomatic_relation = {
							country = PREV
							relation = military_access
							active = no
						}
						diplomatic_relation = {
							country = PREV
							relation = docking_rights
							active = no
						}
					}
				}
			}
		}
	}
	
	var:joining_country = { 
		set_variable = { ai_faction_leader_id = leading_country }
	}
	#log = "========= AI DIPLO: [?joining_country.GetTag] HAS JOINED [?leading_country.GetTag] faction"
	if = {
		limit = {
			is_in_array = { global.ai_faction_diplo_leader = leading_country }
		}
		
		## apply faction diplo so it aligns with the "leading_country"
		var:leading_country = {
			
			for_each_loop = {
				array = ai_faction_desire_target
				
				set_temp_variable = { action = ai_faction_desire_action^i }
				set_temp_variable = { strategy_value = ai_faction_desire_value^i }
				
				var:v = {
					if = {
						limit = {
							is_in_faction = yes
						}
						#log = "  ---> ai_faction_desire_target: [?v.GetTag] | action: [?action.GetTokenKey] | value: [?strategy_value]"
							
						for_each_scope_loop = {
							array = faction_members
								
							var:joining_country = {
								
								#log = "      -[This.GetTag] | APPLY strategy towards [?Prev.GetTag]"
								
								meta_effect = {
									text = {
										add_ai_strategy = {
											type = diplo_action_desire
											id = [TAG]
											target = [ACTION]
											value = [VALUE]
										}
									}
									TAG = "[Prev.GetTag]"
									ACTION = "[?action.GetTokenKey]"
									VALUE = "[?strategy_value]"
								}
							}
						}
					}
				}
			}
			
			for_each_loop = {
				array = ai_faction_acceptance_target
				
				set_temp_variable = { action = ai_faction_acceptance_action^i }
				set_temp_variable = { strategy_value = ai_faction_acceptance_value^i }
				
				var:v = {
					if = {
						limit = {
							is_in_faction = yes
						}
						#log = "  ---> ai_faction_acceptance_target: [?v.GetTag] | action: [?action.GetTokenKey] | value: [?strategy_value]"
							
						for_each_scope_loop = {
							array = faction_members
								
							var:joining_country = {
								
								#log = "      -[This.GetTag] | APPLY strategy towards [?Prev.GetTag]"
								
								meta_effect = {
									text = {
										add_ai_strategy = {
											type = diplo_action_acceptance
											id = [TAG]
											target = [ACTION]
											value = [VALUE]
										}
									}
									TAG = "[Prev.GetTag]"
									ACTION = "[?action.GetTokenKey]"
									VALUE = "[?strategy_value]"
								}
							}
						}
					}
				}
			}
			
		}
		
		#log = " "
		#log = "==== OTHER FACTIONS UPDATING STRATEGY ===="
		
		## apply faction diplo from other factions towards "joining_country"
		for_each_scope_loop = {
			array = global.ai_faction_diplo_leader
			
			if = {
				limit = {
					is_in_faction = yes
					NOT = { tag = var:leading_country }
				}
				#log = "[This.GetTag] | update diplo towards [?joining_country.GetTag] with leader [?leading_country.GetTag]"
				
				if = {
					limit = { 
						is_in_array = { ai_faction_desire_target = leading_country }
					}
						
					for_each_loop = {
						array = ai_faction_desire_target
					
						if = {
							limit = {
								check_variable = { v = leading_country }
							}
							set_temp_variable = { action = ai_faction_desire_action^i }
							set_temp_variable = { strategy_value = ai_faction_desire_value^i }
							
							#log = "  ---> ai_faction_desire_target: [?v.GetTag] | action: [?action.GetTokenKey] | value: [?strategy_value]"
							for_each_scope_loop = {
								array = faction_members
									
								#log = "      -[This.GetTag] | APPLY strategy towards [?Prev.GetTag]"
								
								meta_effect = {
									text = {
										add_ai_strategy = {
											type = diplo_action_desire
											id = [TAG]
											target = [ACTION]
											value = [VALUE]
										}
									}
									TAG = "[?joining_country.GetTag]"
									ACTION = "[?action.GetTokenKey]"
									VALUE = "[?strategy_value]"
								}
								
							}
						}
					}
				}

				if = {
					limit = { 
						is_in_array = { ai_faction_acceptance_target = leading_country }
					}
							
					for_each_loop = {
						array = ai_faction_acceptance_target
					
						if = {
							limit = {
								check_variable = { v = leading_country }
							}
							set_temp_variable = { action = ai_faction_acceptance_action^i }
							set_temp_variable = { strategy_value = ai_faction_acceptance_value^i }
							
							#log = "  ---> ai_faction_acceptance_target: [?v.GetTag] | action: [?action.GetTokenKey] | value: [?strategy_value]"
							for_each_scope_loop = {
								array = faction_members
									
								#log = "      -[This.GetTag] | APPLY strategy towards [?Prev.GetTag]"
								
								meta_effect = {
									text = {
										add_ai_strategy = {
											type = diplo_action_acceptance
											id = [TAG]
											target = [ACTION]
											value = [VALUE]
										}
									}
									TAG = "[?joining_country.GetTag]"
									ACTION = "[?action.GetTokenKey]"
									VALUE = "[?strategy_value]"
								}
								
							}
						}
					}
				}

			}
		}
		#log = " "
	}
		
}

ai_update_on_leaving_faction = {
	var:leaving_country = { 
		clear_variable = ai_faction_leader_id
	}
	
	#log = "========= AI DIPLO: [?leaving_country.GetTag] LEAVES [?leading_country.GetTag] faction"
	if = {
		limit = {
			is_in_array = { global.ai_faction_diplo_leader = leading_country }
		}
		
		var:leading_country = {
			
			for_each_loop = {
				array = ai_faction_desire_target
				
				set_temp_variable = { action = ai_faction_desire_action^i }
				set_temp_variable = { strategy_value = ai_faction_desire_value^i }
				multiply_temp_variable = { strategy_value = -1 }
				
				var:v = {
					if = {
						limit = {
							is_in_faction = yes
						}
						#log = "  ---> ai_faction_desire_target: [?v.GetTag] | action: [?action.GetTokenKey] | value: [?strategy_value]"
							
						for_each_scope_loop = {
							array = faction_members
								
							var:leaving_country = {
								
								#log = "      -[This.GetTag] | APPLY (to offset) strategy towards [?Prev.GetTag]"
								meta_effect = {
									text = {
										add_ai_strategy = {
											type = diplo_action_desire
											id = [TAG]
											target = [ACTION]
											value = [VALUE]
										}
									}
									TAG = "[Prev.GetTag]"
									ACTION = "[?action.GetTokenKey]"
									VALUE = "[?strategy_value]"
								}
							}
						}
					}
				}
			}
			
			for_each_loop = {
				array = ai_faction_acceptance_target
				
				set_temp_variable = { action = ai_faction_acceptance_action^i }
				set_temp_variable = { strategy_value = ai_faction_acceptance_value^i }
				multiply_temp_variable = { strategy_value = -1 }
				
				var:v = {
					if = {
						limit = {
							is_in_faction = yes
						}
						#log = "  ---> ai_faction_acceptance_target: [?v.GetTag] | action: [?action.GetTokenKey] | value: [?strategy_value]"
							
						for_each_scope_loop = {
							array = faction_members
								
							var:leaving_country = {
								
								#log = "      -[This.GetTag] | APPLY (to offset) strategy towards [?Prev.GetTag]"
								meta_effect = {
									text = {
										add_ai_strategy = {
											type = diplo_action_acceptance
											id = [TAG]
											target = [ACTION]
											value = [VALUE]
										}
									}
									TAG = "[Prev.GetTag]"
									ACTION = "[?action.GetTokenKey]"
									VALUE = "[?strategy_value]"
								}
							}
						}
					}
				}
			}
		}
		
		#log = " "
		#log = "==== OTHER FACTIONS UPDATING STRATEGY ===="
		
		## apply faction diplo from other factions towards "leaving_country"
		for_each_scope_loop = {
			array = global.ai_faction_diplo_leader
			
			if = {
				limit = {
					is_in_faction = yes
					NOT = { tag = var:leading_country }
				}
				#log = "[This.GetTag] | update diplo towards [?leaving_country.GetTag] with leader [?leading_country.GetTag]"
				
				if = {
					limit = {
						is_in_array = { ai_faction_desire_target = leading_country }
					}
						
					for_each_loop = {
						array = ai_faction_desire_target
					
						
						if = {
							limit = {
								check_variable = { v = leading_country }
							}
							set_temp_variable = { action = ai_faction_desire_action^i }
							set_temp_variable = { strategy_value = ai_faction_desire_value^i }
							multiply_temp_variable = { strategy_value = -1 }
							
							#log = "  ---> ai_faction_desire_target: [?v.GetTag] | action: [?action.GetTokenKey] | value: [?strategy_value]"
							
							for_each_scope_loop = {
								array = faction_members
									
								#log = "      -[This.GetTag] | APPLY (to offset) strategy towards [?leaving_country.GetTag]"
								
								meta_effect = {
									text = {
										add_ai_strategy = {
											type = diplo_action_desire
											id = [TAG]
											target = [ACTION]
											value = [VALUE]
										}
									}
									TAG = "[?leaving_country.GetTag]"
									ACTION = "[?action.GetTokenKey]"
									VALUE = "[?strategy_value]"
								}
								
							}
						}
					}
				}
						
				if = {
					limit = {
						is_in_array = { ai_faction_acceptance_target = leading_country }
					}
						
					for_each_loop = {
						array = ai_faction_acceptance_target
					
						if = {
							limit = {
								check_variable = { v = leading_country }
							}
							set_temp_variable = { action = ai_faction_acceptance_action^i }
							set_temp_variable = { strategy_value = ai_faction_acceptance_value^i }
							multiply_temp_variable = { strategy_value = -1 }
								
							#log = "  ---> ai_faction_acceptance_target: [?v.GetTag] | action: [?action.GetTokenKey] | value: [?strategy_value]"
							
							for_each_scope_loop = {
								array = faction_members
									
								#log = "      -[This.GetTag] | APPLY (to offset) strategy towards [?leaving_country.GetTag]"
								
								meta_effect = {
									text = {
										add_ai_strategy = {
											type = diplo_action_acceptance
											id = [TAG]
											target = [ACTION]
											value = [VALUE]
										}
									}
									TAG = "[?leaving_country.GetTag]"
									ACTION = "[?action.GetTokenKey]"
									VALUE = "[?strategy_value]"
								}
								
							}
						}
					}
				}
						
			}
		}
	}
	
}

#FROM is former leader 
ai_update_on_assume_faction_leadership = { #transfer diplo data to the new leader
	if = { 
		limit = {
			is_in_array = { global.ai_faction_diplo_leader = FROM }
		}
		#log = "FROM [FROM.GetTag] in array"
		
		for_each_scope_loop = {
			array = global.ai_faction_diplo_leader
			
			#log = "[This.GetTag] has targeted strats towards FROM"
			for_each_loop = {
				array = ai_faction_desire_target
				
				if = {
					limit = {
						check_variable = { v = FROM }
					}
					set_variable = { ai_faction_desire_target^i = ROOT }
					#log = "    -replaced [From.GetTag] with [Root.GetTag] target | desire"
				}
			}
			for_each_loop = {
				array = ai_faction_acceptance_target
				
				if = {
					limit = {
						check_variable = { v = FROM }
					}
					set_variable = { ai_faction_acceptance_target^i = ROOT }
					#log = "    -replaced [From.GetTag] with [Root.GetTag] target | acceptance"
				}
			}
		}
			
		for_each_loop = {
			array = FROM.ai_faction_desire_target
			
			add_to_array = { ROOT.ai_faction_desire_target = v }
			add_to_array = { ROOT.ai_faction_desire_action = ai_faction_desire_action^i }
			add_to_array = { ROOT.ai_faction_desire_value = ai_faction_desire_value^i }
			#log = "[?v.GetTag] [?ai_faction_desire_action^i.GetTokenKey] [?ai_faction_desire_value^i] transferred"
		}
		clear_array = FROM.ai_faction_desire_target
		clear_array = FROM.ai_faction_desire_action
		clear_array = FROM.ai_faction_desire_value
		
		for_each_loop = {
			array = FROM.ai_faction_acceptance_target
			
			add_to_array = { ROOT.ai_faction_acceptance_target = v }
			add_to_array = { ROOT.ai_faction_acceptance_action = ai_faction_acceptance_action^i }
			add_to_array = { ROOT.ai_faction_acceptance_value = ai_faction_acceptance_value^i }
			#log = "[?v.GetTag] [?ai_faction_acceptance_action^i.GetTokenKey] [?ai_faction_acceptance_value^i] transferred"
		}
		clear_array = FROM.ai_faction_acceptance_target
		clear_array = FROM.ai_faction_acceptance_action
		clear_array = FROM.ai_faction_acceptance_value
		
		for_each_scope_loop = {
			array = allies
			
			set_variable = { ai_faction_leader_id = ROOT }
		}
	}
}

ai_update_diplomacy = {
	### ask_for_state_control
	
	if = {
		limit = {
			any_of_scopes = {
				array = global.players
				
				is_in_faction_with = ROOT
			}
			OR = {
				is_in_faction = yes
				is_subject = yes
				num_subjects > 0
			}
		}
		
		for_each_scope_loop = {
			array = global.players
			
			if = {
				limit = {
					OR = {
						is_in_faction_with = PREV
						is_subject_of = PREV
						PREV = { is_subject_of = PREV }
					}
					NOT = { PREV = { has_country_flag = ai_diplo:state_acceptance_@PREV } }
				}
				
				PREV = {
				
					set_country_flag = ai_diplo:state_acceptance_@PREV
					
					meta_effect = {
						text = {
							add_ai_strategy = {
								type = diplo_action_acceptance
								id = [X]
								target = ask_for_state_control
								value = 5000
							}
							add_ai_strategy = {
								type = diplo_action_acceptance
								id = [X]
								target = give_state_control
								value = 5000
							}
						}
						X = "[Prev.GetTag]"
					}
				}
			}
		}
	}
	 
}

ai_update_manual_faction_check = { # when a faction gets formed from nothing

	if = {
		limit = {
			is_in_faction = yes
		}
		
		if = { #faction leader has changed, so we must have left and joined another faction
			limit = {
				NOT = { check_variable = { ai_faction_leader_id = faction_leader } }
			}
			
			log = "[This.GetTag] | MANUAL FACTION SWITCH CHECK | ai_faction_leader_id: [?ai_faction_leader_id.GetTag] | faction_leader: [?faction_leader.GetTag]"
			if = {
				limit = {
					has_variable = ai_faction_leader_id
				}
					
				set_temp_variable = { leaving_country = THIS }
				set_temp_variable = { leading_country = ai_faction_leader_id }
				
				ai_update_on_leaving_faction = yes
			}
			
			set_temp_variable = { joining_country = THIS }
			set_temp_variable = { leading_country = faction_leader }
			
			ai_update_on_joining_faction = yes
			
			d_ai_update_countries_to_defend_us = yes
		}
	}
	else_if = {
		limit = { has_variable = ai_faction_leader_id }

		log = "[This.GetTag] | MANUAL FACTION LEAVE CHECK | ai_faction_leader_id: [?ai_faction_leader_id.GetTag] | faction_leader: [?faction_leader.GetTag]"
		set_temp_variable = { leaving_country = THIS }
		set_temp_variable = { leading_country = ai_faction_leader_id }
		
		ai_update_on_leaving_faction = yes
	}
}

ai_update_diplomacy_startup = {

	if = {
		limit = {
			has_dlc = "Arms Against Tyranny"
		}
			
		## every market access set on startup should persist
		
		every_other_country = {
			limit = {
				PREV = { has_market_access_with = PREV }
			}
			PREV = {
				meta_effect = {
					text = {
						add_ai_strategy = {
							type = diplo_action_desire
							id = [X]
							target = market_access_rights
							value = 60
						}
					}
					X = "[Prev.GetTag]"
				}
			}
			meta_effect = {
				text = {
					add_ai_strategy = {
						type = diplo_action_desire
						id = [X]
						target = market_access_rights
						value = 60
					}
				}
				X = "[Prev.GetTag]"
			}
			
		}
		
		## every democracy should like other democracies market access
		
		if = {
			limit = {
				OR = {
					has_government = conservatism
					has_government = liberalism
					has_government = socialism
					has_government = agrarianism
				}
			}
				
			every_other_country = {
				limit = {
					NOT = { has_government = PREV }
					OR = {
						has_government = conservatism
						has_government = liberalism
						has_government = socialism
						has_government = agrarianism
					}
				}

				meta_effect = {
					text = {
						add_ai_strategy = {
							type = equipment_market_trade_desire
							id = [X]
							value = 15
						}
					}
					X = "[Prev.GetTag]"
				}
			}
			
		}
	}
}

ai_favour_acceptance = { #ROOT = sender; THIS = receiver
	if = {
		limit = {
			check_variable = { ai_always_accept > 0 }
		}
		set_temp_variable = { positive = 10000 }
	}
	else_if = {
		limit = {
			check_variable = { has_done_ai_score = 0 }
			diplomacy_favour_ai_acceptance = yes
		}
	}
	
	######## TOOLTIP ########
	
	set_temp_variable = { ai_score = positive }
	subtract_from_temp_variable = { ai_score = negative }
	if = {
		limit = {
			check_variable = { positive > negative }
		}
		custom_effect_tooltip = FAVOUR_AI_ACCEPT
	}
	else = {
		custom_effect_tooltip = FAVOUR_AI_DECLINE
	}
	custom_effect_tooltip = FAVOUR_AI_DESCRIPTION
	
	## Positive modifiers
	
	if = {
		limit = {
			check_variable = { faction > 0 }
		}
		custom_effect_tooltip = FAVOUR_AI_ACCEPTANCE_FACTION
	}
	if = {
		limit = {
			check_variable = { subject > 0 }
		}
		custom_effect_tooltip = FAVOUR_AI_ACCEPTANCE_SUBJECT
	}
	if = {
		limit = {
			check_variable = { favour_prefer > 0 }
		}
		custom_effect_tooltip = FAVOUR_AI_ACCEPTANCE_PREFER
	}
	if = {
		limit = {
			check_variable = { opinion > 0 }
		}
		custom_effect_tooltip = FAVOUR_AI_ACCEPTANCE_OPINION
	}
	
		custom_effect_tooltip = space_TT
	## Negative modifiers
	
	custom_effect_tooltip = FAVOUR_AI_ACCEPTANCE_BASE
	
	if = {
		limit = {
			check_variable = { opinion < 0 }
		}
		custom_effect_tooltip = FAVOUR_AI_ACCEPTANCE_OPINION
	}
	if = {
		limit = {
			check_variable = { favour_already < 0 }
		}
		custom_effect_tooltip = FAVOUR_AI_ACCEPTANCE_FAVOUR
	}
}

ai_update_improve_relation = {
	if = {
		limit = {
			major_country = yes
		}
		set_temp_variable = { max_improve_relation = 3 }
	}
	else_if = {
		limit = {
			NOT = {
				has_country_flag = ai_is_useless_country
			}
			is_subject = no
		}
		set_temp_variable = { max_improve_relation = 1 }
	}
	#set_temp_variable = { max_improve_relation = 0 }
	
	if = {
		limit = {
			OR = {
				has_government = communism
				has_government = fascism
			}
		}
		set_temp_variable = { evaluate_ideology_1 = current_party_ideology_group }
	}
	else_if = {
		limit = {
			OR = {
				has_government = monarchism
				has_government = neutrality
			}
		}
		set_temp_variable = { evaluate_ideology_1 = token:monarchism }
		set_temp_variable = { evaluate_ideology_2 = token:neutrality }
	}
	else = {
		set_temp_variable = { evaluate_ideology_1 = token:conservatism }
		set_temp_variable = { evaluate_ideology_2 = token:liberalism }
		set_temp_variable = { evaluate_ideology_3 = token:socialism }
	}
	
	####### COUNTRY SPECIFIC TARGETS
	
	clear_temp_array = possible_target
	if = {
		limit = {
			tag = GER
		}
		add_to_temp_array = { possible_target = JAP }
	}
	
	get_sorted_scored_countries_temp = {
		scorer = ai_GetImproveRelationTarget
		array = scorer_output
		scores = scorer_output_score
	}
	
	for_each_loop = {
		array = scorer_output
		
		if = {
			limit = {
				check_variable = { max_improve_relation > max }
			}
			add_to_temp_array = { ai_new_improve_relation = v }
		}
		else = { set_temp_variable = { break = 1 } }
			
		add_to_temp_variable = { max = 1 }
	}
	
	for_each_loop = { # Existing target is no longer included in the top targets. Remove it
		array = ai_improve_relation_targets
		
		if = {
			limit = {
				NOT = { is_in_array = { ai_new_improve_relation = v } }
			}
			add_to_temp_array = { remove_improve_opinion = v }
			meta_effect = {
				text = {
					add_ai_strategy = {
						type = diplo_action_desire
						id = [X] 
						target = improve_relation
						value = -999
					}
				}
				X = "[?v.GetTag]"
			}
			var:v = { cancel_improve_relations = yes }
		}
	}
	for_each_loop = { array = remove_improve_opinion remove_from_array = { ai_improve_relation_targets = v } }
				
	for_each_loop = { #New target is not an existing target. Apply ai strategy
		array = ai_new_improve_relation
		
		if = {
			limit = {
				NOT = { is_in_array = { ai_improve_relation_targets = v } }
			}
			add_to_array = { ai_improve_relation_targets = v }
			meta_effect = {
				text = {
					add_ai_strategy = {
						type = diplo_action_desire
						id = [X] 
						target = improve_relation
						value = 999
					}
				}
				X = "[?v.GetTag]"
			}
		}
	}
	
	#log = "ai_new_improve_relation: [?ai_new_improve_relation^num]====================================="
	#for_each_loop = {
	#	array = ai_new_improve_relation
	#	
	#	var:v = {
	#		log = "[?This.GetName]"
	#	}
	#}
	#log = "ai_improve_relation_targets: [?ai_improve_relation_targets^num]====================================="
	#for_each_loop = {
	#	array = ai_improve_relation_targets
	#	
	#	var:v = {
	#		log = "[?This.GetName]"
	#	}
	#}
	#log = "scorer_output: [?scorer_output^num]====================================="
	#for_each_loop = {
	#	array = scorer_output
	#	
	#	var:v = {
	#		log = "[?This.GetName] | [?scorer_output_score^i]"
	#	}
	#}
}

ai_update_favours = {

	clear_temp_array = available_favours
	for_each_loop = {
		array = global.diplomatic_favours
		
		if = {
			limit = {
				NOT = { has_variable = ROOT.favour@var:v }
			}
			add_to_temp_array = { available_favours = v }
		}
	}
	
	if = {
		limit = {
			check_variable = { available_favours^num > 0 }
		}
		
		for_each_scope_loop = {
			array = befriend_targets
			
			if = {
				limit = {
					exists = yes
					NOT = { tag = ROOT }
					
					can_send_favour_request = yes
					
					NOT = {
						any_of = {
							array = alerts_sender
							
							var:v = { tag = ROOT }
						}
						any_of = {
							array = notification_sender
							
							var:v = { tag = ROOT }
						}
						any_of = {
							array = notification_target
							
							check_variable = { v = ROOT }
						}
					}
					set_temp_variable = { best_favour_score = 0 }	
					set_temp_variable = { best_favour = 0 }	
				}
					
				for_each_loop = {
					array = available_favours
					value = favour_v
					
					if = {
						limit = {
							NOT = { has_variable = favour@var:favour_v }
							
							diplomacy_favour_ai_acceptance = yes
							#log = "[?positive] Positive / [?negative] Negative"
							check_variable = { positive > negative }
							NOT = { is_in_array = { proposed_favour = favour_v } }
							
							can_propose_favour = yes
						}
							
						meta_effect = {
							text = {
								set_temp_variable = { score = mtth:[V] }
							}
							V = "[?favour_v.GetTokenKey]"
						}
						if = {
							limit = {
								check_variable = { score > 0 }
							}
							randomize_temp_variable = {
								var = random_score_addition
								distribution = uniform
								min = 0
								max = 0.1
							}
							add_to_temp_variable = { score = random_score_addition }
						}
						
						if = {
							limit = {
								check_variable = { score > best_favour_score }
							}
							set_temp_variable = { best_favour_score = score }
							set_temp_variable = { best_favour = favour_v }
						}
					}
				}
				
				if = {
					limit = {
						check_variable = { best_favour_score > 0 }
					}
					set_temp_variable = { favour_v = best_favour }
					#log = "[?best_favour_score] best_favour_score"
					#log = "[?favour_v.GetTokenKey] favour_v"
					set_temp_variable = { sender = ROOT }
					set_temp_variable = { receiver = THIS }
					request_favour = yes
					add_to_temp_array = { proposed_favour = favour_v }
				}
			}
		}
	}
}
